<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang chủ - MusicPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #050505;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding-top: 70px; /* For fixed navbar */
            min-height: 100vh;
        }

        .section-title {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: white;
            border-bottom: 2px solid #00f3ff;
            padding-bottom: 8px;
        }

        .custom-card {
            background: #181818;
            padding: 16px;
            border-radius: 8px;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
            height: 100%;
        }

        .custom-card:hover {
            background: #282828;
            transform: translateY(-5px);
        }

        .play-btn-hover {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: #1db954;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            opacity: 0;
            transition: 0.3s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: black;
            z-index: 2;
        }

        .custom-card:hover .play-btn-hover {
            opacity: 1;
        }

        .custom-card:hover img {
            opacity: 0.6;
        }

        .hero-section {
            background: linear-gradient(135deg, #092c16 0%, #000000 100%);
            padding: 40px 0;
            border-radius: 12px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://placehold.co/1920x400') center/cover;
            opacity: 0.3;
        }
    </style>
</head>
<body>
<!-- Include Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid py-4 px-5">
    <!-- Hero Section -->
    <div class="hero-section mb-5 position-relative">
        <div class="position-relative z-1 container">
            <h1 class="display-4 fw-bold text-white mb-3">Chào mừng trở lại!</h1>
            <p class="fs-5 text-white-50 mb-4">Hôm nay bạn muốn nghe gì?</p>
            <button class="btn btn-info btn-lg rounded-pill px-4" onclick="playRandom()">
                <i class="bi bi-shuffle me-2"></i> Phát ngẫu nhiên
            </button>
        </div>
    </div>

    <!-- Recommended For You -->
    <div class="mb-5">
        <h3 class="section-title">
            <i class="bi bi-stars text-warning me-2"></i>Đề xuất cho bạn
        </h3>
        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="recommend-list">
            <div class="col">
                <div class="text-center py-5">
                    <div class="spinner-border text-info"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Releases -->
    <div class="mb-5">
        <h3 class="section-title">
            <i class="bi bi-megaphone text-info me-2"></i>Mới phát hành
        </h3>
        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="new-release-list">
            <!-- Loaded dynamically -->
        </div>
    </div>

    <!-- Trending -->
    <div class="mb-5">
        <h3 class="section-title">
            <i class="bi bi-fire text-danger me-2"></i>Xu hướng
        </h3>
        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="trending-list">
            <!-- Loaded dynamically -->
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mt-5">
        <div class="col-md-4">
            <div class="card bg-dark border-info text-center p-4 hover-scale" onclick="window.location.href='/ai-dj.html'">
                <i class="bi bi-robot text-info fs-1 mb-3"></i>
                <h5 class="text-white fw-bold">AI DJ</h5>
                <p class="text-white-50 small">Playlist thông minh theo tâm trạng</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-dark border-success text-center p-4 hover-scale" onclick="window.location.href='/for-you.html'">
                <i class="bi bi-heart text-success fs-1 mb-3"></i>
                <h5 class="text-white fw-bold">Dành cho bạn</h5>
                <p class="text-white-50 small">Khám phá bài hát phù hợp</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-dark border-warning text-center p-4 hover-scale" onclick="window.location.href='/ranking.html'">
                <i class="bi bi-trophy text-warning fs-1 mb-3"></i>
                <h5 class="text-white fw-bold">Bảng xếp hạng</h5>
                <p class="text-white-50 small">Top bài hát phổ biến</p>
            </div>
        </div>
    </div>
</div>

<!-- Footer Player -->
<div class="position-fixed bottom-0 start-0 end-0 bg-black border-top border-secondary p-3" style="z-index: 1050; height: 90px;">
    <div class="d-flex align-items-center justify-content-between h-100">
        <div class="d-flex align-items-center" style="width: 30%;">
            <img id="player-img" src="https://placehold.co/60" class="rounded me-3">
            <div>
                <div class="fw-bold text-white" id="player-title">Chọn bài hát</div>
                <small class="text-white-50" id="player-artist">--</small>
            </div>
        </div>
        <div class="d-flex flex-column align-items-center" style="width: 40%;">
            <div class="d-flex gap-4 mb-2 align-items-center">
                <i class="bi bi-shuffle text-secondary cursor-pointer"></i>
                <i class="bi bi-skip-start-fill fs-4 text-white cursor-pointer"></i>
                <i class="bi bi-play-circle-fill fs-1 text-white hover-scale cursor-pointer" id="player-play-btn"></i>
                <i class="bi bi-skip-end-fill fs-4 text-white cursor-pointer"></i>
                <i class="bi bi-repeat text-secondary cursor-pointer"></i>
            </div>
            <div class="w-100 d-flex align-items-center gap-2">
                <small class="text-secondary">0:00</small>
                <input type="range" class="form-range" id="player-progress" value="0">
                <small class="text-secondary">--:--</small>
            </div>
        </div>
        <div class="d-flex justify-content-end align-items-center" style="width: 30%;">
            <i class="bi bi-volume-up text-secondary me-2"></i>
            <input type="range" class="form-range" style="width: 100px;">
        </div>
    </div>
    <audio id="main-audio" src=""></audio>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = '/api';
    const USER_ID = localStorage.getItem('music_user_id') || 1;

    // Load homepage data
    async function loadHomeData() {
        try {
            const res = await fetch(`${API}/dashboard/${USER_ID}`);
            const data = await res.json();

            // Render recommended songs
            renderCardGrid(data.recommendedSongs, 'recommend-list');

            // Render new releases
            renderCardGrid(data.newReleases, 'new-release-list');

            // Render trending songs
            renderCardGrid(data.trendingSongs, 'trending-list');

        } catch (error) {
            console.error('Error loading home data:', error);
        }
    }

    // Render card grid
    function renderCardGrid(list, containerId) {
        const container = document.getElementById(containerId);
        if (!container || !list) return;

        container.innerHTML = list.map(song => `
                <div class="col">
                    <div class="custom-card position-relative">
                        <div class="position-relative mb-2">
                            <img src="${song.coverImage || 'https://placehold.co/300'}"
                                 class="w-100 rounded shadow-sm" style="aspect-ratio: 1/1; object-fit: cover;">
                            <div class="play-btn-hover" onclick="playSong(${song.songId})">
                                <i class="bi bi-play-fill"></i>
                            </div>
                        </div>
                        <div onclick="navigateToSong(${song.songId})" class="cursor-pointer">
                            <h6 class="text-white text-truncate fw-bold mb-1">${song.title}</h6>
                            <small class="text-white-50">${song.artist?.name || 'Unknown'}</small>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    // Navigate to song detail
    function navigateToSong(songId) {
        window.location.href = `/song-detail.html?id=${songId}`;
    }

    // Play song
    async function playSong(songId) {
        try {
            // Record in history
            await fetch(`${API}/history?userId=${USER_ID}&songId=${songId}`, {
                method: 'POST'
            });

            // Update player UI
            const songRes = await fetch(`${API}/songs/${songId}/detail`);
            const songData = await songRes.json();
            const song = songData.song;

            document.getElementById('player-title').textContent = song.title;
            document.getElementById('player-artist').textContent = song.artist?.name || 'Unknown';
            document.getElementById('player-img').src = song.coverImage || 'https://placehold.co/60';

            // Play audio if available
            const audio = document.getElementById('main-audio');
            if (song.filePath) {
                audio.src = song.filePath;
                audio.play();
                document.getElementById('player-play-btn').className = 'bi bi-pause-circle-fill fs-1 text-white hover-scale cursor-pointer';
            }

        } catch (error) {
            console.error('Error playing song:', error);
        }
    }

    // Play random
    async function playRandom() {
        try {
            const res = await fetch(`${API}/songs/random`);
            const song = await res.json();
            if (song.songId) {
                playSong(song.songId);
            }
        } catch (error) {
            console.error('Error playing random:', error);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadHomeData);
</script>
<script src="/js/global-player.js"></script>
</body>
</html>