<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${playlist.name} + ' | MusicPro'">Chi tiết Playlist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f9f9f9; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        /* Sidebar Style (Đã có trong fragment nhưng thêm để đảm bảo layout) */
        .main-content { margin-left: 240px; padding-bottom: 80px; }

        /* Header Playlist */
        .playlist-header { position: relative; height: 350px; overflow: hidden; color: white; }
        .blur-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(20px) brightness(0.6);
            z-index: 0; transform: scale(1.1);
        }
        .header-content { position: relative; z-index: 1; display: flex; align-items: flex-end; height: 100%; padding: 30px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        .pl-img { width: 200px; height: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-radius: 8px; object-fit: cover; }

        /* Table & Actions */
        .hover-visible { opacity: 0; transition: opacity 0.2s; }
        .group-hover-action:hover .hover-visible { opacity: 1; }
        .song-img-container { position: relative; width: 40px; height: 40px; display: block; }
        .song-img-container img { transition: 0.3s; }
        .mini-play-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 20px; opacity: 0; transition: all 0.2s; z-index: 10;
        }
        .group-hover-action:hover .mini-play-btn { opacity: 1; }
        .group-hover-action:hover .song-img-container img { opacity: 0.5; filter: brightness(0.7); }
        .cursor-pointer { cursor: pointer; }

        /* Modal Styles */
        .modal-content { background-color: #212529; color: white; border: 1px solid #444; }
        .form-control { background-color: #2b3035; border: 1px solid #444; color: white; }
        .form-control:focus { background-color: #2b3035; color: white; border-color: #0d6efd; box-shadow: none; }
    </style>
</head>
<body>

<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="main-content">
    <div class="playlist-header">
        <div class="blur-bg" th:style="'background-image: url(' + (${playlist.backgroundImage} ?: (${playlist.imageUrl} ?: 'https://placehold.co/800')) + ');'"></div>
        <div class="header-content container-fluid">
            <img th:src="${playlist.imageUrl} ?: 'https://placehold.co/200'" class="pl-img me-4" id="header-cover-img">
            <div class="pb-2">
                <span class="badge bg-primary mb-2">PLAYLIST</span>
                <h1 class="display-4 fw-bold mb-2" th:text="${playlist.name}" id="header-pl-name">Tên Playlist</h1>
                <p class="opacity-75 mb-3" th:text="${playlist.description}" id="header-pl-desc">...</p>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-primary btn-lg rounded-pill px-4" onclick="alert('Tính năng đang phát triển')">
                        <i class="bi bi-play-fill"></i> Phát ngẫu nhiên
                    </button>
                    <button class="btn btn-outline-light btn-lg rounded-pill px-4" onclick="openEditModal()">
                        <i class="bi bi-pencil-fill me-2"></i> Chỉnh sửa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4 px-4">
        <table class="table table-borderless align-middle table-hover">
            <thead class="text-secondary small border-bottom">
            <tr><th width="50">#</th> <th>BÀI HÁT</th> <th>ALBUM</th> <th class="text-end">THỜI GIAN</th> <th width="50"></th></tr>
            </thead>
            <tbody>
            <tr th:each="item, iStat : ${playlist.playlistSongs}"
                class="song-row border-bottom border-light group-hover-action cursor-pointer"
                th:onclick="'window.location.href=\'/song/' + ${item.song.songId} + '\''">
                <td class="text-center text-muted" th:text="${iStat.count}">1</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="song-img-container rounded me-3" th:onclick="'playSongInList(event, ' + ${item.song.songId} + ')'">
                            <img th:src="${item.song.coverImage} ?: 'https://placehold.co/40'" class="w-100 h-100 object-fit-cover rounded">
                            <div class="mini-play-btn"><i class="bi bi-play-fill"></i></div>
                        </div>
                        <div>
                            <div class="fw-bold text-dark" th:text="${item.song.title}">Title</div>
                            <small class="text-muted" th:text="${item.song.artist != null ? item.song.artist.name : 'Unknown'}">Artist</small>
                        </div>
                    </div>
                </td>
                <td class="text-muted" th:text="${item.song.album != null ? item.song.album.title : ''}">Album</td>
                <td class="text-end text-muted">04:20</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger border-0 rounded-circle hover-visible"
                            title="Xóa khỏi playlist" th:onclick="'removeSong(event, ' + ${item.song.songId} + ')'">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <div th:if="${#lists.isEmpty(playlist.playlistSongs)}" class="text-center py-5 text-muted">
            <i class="bi bi-music-note-list fs-1 d-block mb-3"></i>
            <p>Chưa có bài hát nào trong playlist này.</p>
        </div>

        <hr class="my-5 border-secondary">
        <div class="search-section" style="max-width: 800px;">
            <h4 class="fw-bold mb-3">Thêm bài hát vào playlist</h4>
            <div class="position-relative mb-4">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" id="search-song-input" class="form-control rounded-pill ps-5 py-3" placeholder="Tìm kiếm bài hát..." onkeyup="debounceSearch(this.value)">
            </div>
            <div id="search-results-list" class="list-group list-group-flush"></div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/sidebar :: create-playlist-modal}"></div>

<div class="modal fade" id="editDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title fw-bold">Sửa thông tin chi tiết</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-5 d-flex flex-column align-items-center justify-content-center">
                        <div class="position-relative shadow" style="width: 100%; aspect-ratio: 1/1; background: #333;">
                            <img id="preview-cover" th:src="${playlist.imageUrl} ?: 'https://placehold.co/300'" class="w-100 h-100 object-fit-cover">
                            <input type="file" id="input-cover" class="d-none" accept="image/*" onchange="previewImage(this, 'preview-cover')">
                            <button class="btn btn-light position-absolute top-50 start-50 translate-middle shadow" onclick="document.getElementById('input-cover').click()">
                                <i class="bi bi-camera-fill me-2"></i> Đổi ảnh
                            </button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">TÊN</label>
                            <input type="text" id="edit-name" class="form-control" placeholder="Nhập tên playlist">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">MÔ TẢ</label>
                            <textarea id="edit-desc" class="form-control" rows="3" placeholder="Thêm mô tả"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">CHẾ ĐỘ</label>
                            <div class="form-check form-switch bg-dark border border-secondary rounded p-2 d-flex align-items-center">
                                <input class="form-check-input ms-0 me-3" type="checkbox" role="switch" id="edit-isPublic" onchange="updatePublicLabel('edit-isPublic', 'edit-label-public')" style="width: 2.5em; height: 1.25em;">
                                <span id="edit-label-public" class="fw-bold text-success">Công khai</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">ẢNH NỀN</label>
                            <input type="file" id="input-bg" class="form-control" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-transparent text-white fw-bold" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-light fw-bold rounded-pill px-4" onclick="savePlaylistDetails()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const CURRENT_PLAYLIST_ID = [[${playlist.playlistId}]];
    const USER_ID = localStorage.getItem('music_user_id') || 1;
    const API = "/api";
    let searchTimeout = null;
    const INITIAL_IS_PUBLIC = [[${playlist.isPublic}]] !== null ? [[${playlist.isPublic}]] : true;

    // --- 1. SIDEBAR LOGIC (NEW: Expandable & Active State) ---
    let sidebarPlaylistsData = [];
    let isSidebarExpanded = false;

    async function loadSidebarPlaylists() {
        try {
            const res = await fetch(`${API}/playlists/user/${USER_ID}`);
            if(res.ok) {
                const data = await res.json();
                sidebarPlaylistsData = data.sort((a, b) => b.playlistId - a.playlistId);
                renderSidebarUI();
            }
        } catch(e) { console.error("Sidebar load err", e); }
    }

    function renderSidebarUI() {
        const container = document.getElementById('sidebar-playlists');
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(!container) return;
        container.innerHTML = '';

        const limit = isSidebarExpanded ? sidebarPlaylistsData.length : 5;
        const displayList = sidebarPlaylistsData.slice(0, limit);

        displayList.forEach(p => {
            // [LOGIC MỚI] Kiểm tra playlist hiện tại để highlight
            const isActive = (p.playlistId === CURRENT_PLAYLIST_ID)
                ? 'text-white bg-secondary bg-opacity-25'
                : 'text-white-50';

            container.innerHTML += `
                <a href="/playlist/${p.playlistId}" class="nav-link text-truncate py-2 ${isActive}" style="font-size: 0.9rem;">
                    <i class="bi bi-music-note-list"></i> ${p.name}
                </a>`;
        });

        if (sidebarPlaylistsData.length > 5) {
            btnExpand.classList.remove('d-none');
            btnExpand.innerHTML = isSidebarExpanded
                ? 'Thu gọn <i class="bi bi-chevron-up ms-1"></i>'
                : `Xem thêm (${sidebarPlaylistsData.length - 5}) <i class="bi bi-chevron-down ms-1"></i>`;
        } else {
            btnExpand.classList.add('d-none');
        }
    }

    // Gán sự kiện cho Sidebar (Chạy khi DOM load)
    document.addEventListener('DOMContentLoaded', () => {
        // Sự kiện Xem thêm
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(btnExpand) {
            btnExpand.addEventListener('click', () => {
                isSidebarExpanded = !isSidebarExpanded;
                renderSidebarUI();
            });
        }
        // Sự kiện Tạo playlist (Từ fragment sidebar)
        const btnCreate = document.getElementById('btn-create-playlist');
        if(btnCreate) {
            btnCreate.addEventListener('click', openCreateModal);
        }
    });

    // Gọi load sidebar ngay
    loadSidebarPlaylists();

    // --- 2. LOGIC TẠO PLAYLIST (Từ Sidebar Fragment) ---
    function openCreateModal() {
        document.getElementById('newPlName').value = '';
        document.getElementById('isPublicCheck').checked = true;
        updatePublicLabel('isPublicCheck', 'label-public');
        new bootstrap.Modal(document.getElementById('createPlModal')).show();
    }
    async function createPlaylist() {
        const name = document.getElementById('newPlName').value;
        const isPublic = document.getElementById('isPublicCheck').checked;
        if(!name) return alert("Vui lòng nhập tên Playlist");
        try {
            await fetch(`${API}/playlists`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ userId: USER_ID, name: name, isPublic: isPublic })
            });
            alert("Tạo thành công!");
            bootstrap.Modal.getInstance(document.getElementById('createPlModal')).hide();
            loadSidebarPlaylists();
        } catch (e) { console.error(e); }
    }

    // --- 3. OTHER ACTIONS (Edit, Play, Search...) ---

    // (Giữ nguyên các hàm updatePublicLabel, openEditModal, savePlaylistDetails, playSongInList, removeSong...)
    function updatePublicLabel(inputId, labelId) {
        const isChecked = document.getElementById(inputId).checked;
        const label = document.getElementById(labelId);
        if(isChecked) {
            label.innerText = "Công khai"; label.className = "fw-bold text-success d-block";
        } else {
            label.innerText = "Riêng tư"; label.className = "fw-bold text-danger d-block";
        }
    }

    function playSongInList(event, songId) {
        event.stopPropagation();
        fetch(`${API}/history?userId=${USER_ID}&songId=${songId}`, {method: 'POST'});
        alert(`Đang phát nhạc (ID: ${songId})`);
    }

    async function removeSong(event, songId) {
        event.stopPropagation();
        if(!confirm("Xóa bài hát này khỏi Playlist?")) return;
        try {
            const res = await fetch(`${API}/playlists/${CURRENT_PLAYLIST_ID}/songs/${songId}`, { method: 'DELETE' });
            if(res.ok) location.reload();
        } catch(e) { console.error(e); }
    }

    function openEditModal() {
        loadEditData();
        new bootstrap.Modal(document.getElementById('editDetailsModal')).show();
    }
    function loadEditData() {
        document.getElementById('edit-name').value = document.getElementById('header-pl-name').innerText;
        const desc = document.getElementById('header-pl-desc').innerText;
        document.getElementById('edit-desc').value = (desc === '...') ? '' : desc;
        document.getElementById('edit-isPublic').checked = INITIAL_IS_PUBLIC;
        updatePublicLabel('edit-isPublic', 'edit-label-public');
        document.getElementById('input-cover').value = '';
        document.getElementById('input-bg').value = '';
    }
    async function savePlaylistDetails() {
        const btn = event.target; btn.disabled = true; btn.innerText = "Đang lưu...";
        const newName = document.getElementById('edit-name').value;
        const newDesc = document.getElementById('edit-desc').value;
        const newIsPublic = document.getElementById('edit-isPublic').checked;
        const coverFile = document.getElementById('input-cover').files[0];
        const bgFile = document.getElementById('input-bg').files[0];
        try {
            await fetch(`${API}/playlists/${CURRENT_PLAYLIST_ID}`, {
                method: 'PATCH', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name: newName, description: newDesc, isPublic: newIsPublic })
            });
            if (coverFile || bgFile) {
                const formData = new FormData();
                if(coverFile) formData.append('cover', coverFile);
                if(bgFile) formData.append('background', bgFile);
                await fetch(`${API}/playlists/${CURRENT_PLAYLIST_ID}/images`, { method: 'POST', body: formData });
            }
            location.reload();
        } catch (err) { alert("Lỗi: " + err.message); btn.disabled = false; btn.innerText = "Lưu"; }
    }

    function debounceSearch(keyword) {
        clearTimeout(searchTimeout);
        if (!keyword.trim()) { document.getElementById('search-results-list').innerHTML = ''; return; }
        searchTimeout = setTimeout(() => doSearchSongs(keyword), 400);
    }
    async function doSearchSongs(keyword) {
        try {
            const res = await fetch(`${API}/playlists/search-songs?keyword=${encodeURIComponent(keyword)}`);
            const songs = await res.json();
            const list = document.getElementById('search-results-list');
            list.innerHTML = '';
            if(songs.length === 0) { list.innerHTML = '<div class="text-center text-muted py-3">Không tìm thấy bài hát nào</div>'; return; }
            songs.forEach(s => {
                list.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center bg-light mb-2 rounded border-0">
                        <div class="d-flex align-items-center">
                            <img src="${s.coverImage || 'https://placehold.co/40'}" class="rounded me-3" width="40" height="40">
                            <div><div class="fw-bold">${s.title}</div><small class="text-muted">${s.artist ? s.artist.name : 'Unknown'}</small></div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="addSongToPlaylist(${s.songId})">Thêm</button>
                    </div>`;
            });
        } catch(e) {}
    }
    async function addSongToPlaylist(songId) {
        try {
            const res = await fetch(`${API}/playlists/${CURRENT_PLAYLIST_ID}/songs`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ songId: songId })
            });
            if(res.ok) location.reload();
        } catch(e) {}
    }
    function previewImage(input, targetId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById(targetId).src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
</body>
</html>