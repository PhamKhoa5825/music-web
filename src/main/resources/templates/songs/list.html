<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>Songs</title>
</head>

<body>
<div layout:fragment="content">

    <!-- ‚úÖ TH√äM: SCRIPT ·∫®N CH·ª®A D·ªÆ LI·ªÜU JSON (THYMELEAF RENDER M·ªñI L·∫¶N) -->
    <script type="application/json" id="songs-data" th:inline="javascript">
        /*[[${songs.content}]]*/
    </script>

    <div class="page-header">
        <h1>All Songs</h1>
    </div>

    <div class="filter-bar">
        <form hx-get="/songs"
              hx-target="#main-content"
              hx-select="#main-content"
              hx-push-url="true"
              hx-trigger="submit"
              class="filter-form"
              onsubmit="return false;">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="title"
                       th:value="${title}"
                       placeholder="Search songs..."
                       class="filter-input"
                       hx-get="/songs"
                       hx-trigger="keyup changed delay:500ms"
                       hx-target="#main-content"
                       hx-select="#main-content"
                       hx-include=".filter-form">
            </div>

            <select name="artistId" class="filter-select"
                    hx-get="/songs"
                    hx-trigger="change"
                    hx-target="#main-content"
                    hx-select="#main-content"
                    hx-include=".filter-form">
                <option value="">All Artists</option>
                <option th:each="artist : ${artists}"
                        th:value="${artist.artistId}"
                        th:text="${artist.name}"
                        th:selected="${artist.artistId == selectedArtistId}">
                </option>
            </select>

            <select name="albumId" class="filter-select"
                    hx-get="/songs"
                    hx-trigger="change"
                    hx-target="#main-content"
                    hx-select="#main-content"
                    hx-include=".filter-form">
                <option value="">All Albums</option>
                <option th:each="album : ${albums}"
                        th:value="${album.albumId}"
                        th:text="${album.title}"
                        th:selected="${album.albumId == selectedAlbumId}">
                </option>
            </select>

            <select name="genreId" class="filter-select"
                    hx-get="/songs"
                    hx-trigger="change"
                    hx-target="#main-content"
                    hx-select="#main-content"
                    hx-include=".filter-form">
                <option value="">All Genres</option>
                <option th:each="genre : ${genres}"
                        th:value="${genre.genreId}"
                        th:text="${genre.name}"
                        th:selected="${genre.genreId == selectedGenreId}">
                </option>
            </select>

            <button type="submit" class="btn btn-search">
                <i class="fas fa-search"></i> Search
            </button>

            <a href="/songs" class="btn btn-reset" hx-boost="true">
                <i class="fas fa-redo"></i> Reset
            </a>
        </form>
    </div>

    <div class="songs-table-container">
        <table class="songs-table">
            <thead>
            <tr>
                <th class="col-number">#</th>
                <th class="col-title">Title</th>
                <th class="col-artist">Artist</th>
                <th class="col-album">Album</th>
                <th class="col-genre">Genre</th>
                <th class="col-views">View</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="song, iterStat : ${songs.content}"
                class="song-row"
                th:data-song-id="${song.songId}">

                <td class="col-number">
                    <span class="row-number" th:text="${songs.number * songs.size + iterStat.index + 1}">1</span>
                </td>

                <td class="col-title">
                    <div class="title-cell">
                        <div class="song-cover play-song-trigger"
                             th:data-song-id="${song.songId}">
                            <img th:src="${song.imageUrl}" alt="Cover Image">
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="song-title-info">
                            <a th:href="@{/songs/{id}(id=${song.songId})}"
                               class="song-name song-link"
                               th:text="${song.title}">
                                Song Title
                            </a>
                        </div>
                    </div>
                </td>

                <td class="col-artist">
                    <a th:href="@{/artists/{id}(id=${song.artistId})}"
                       class="artist-link"
                       th:text="${song.artistName}">Artist</a>
                </td>

                <td class="col-album">
                    <div class="album-cell" th:if="${song.albumId}">
                        <i class="fas fa-compact-disc"></i>
                        <a th:href="@{/albums/{id}(id=${song.albumId})}"
                           class="album-link"
                           th:text="${song.albumTitle}">Album</a>
                    </div>
                    <span th:unless="${song.albumId}" class="no-album">-</span>
                </td>

                <td class="col-genre">
                    <span th:each="genre, iter : ${song.genres}">
                        <a th:href="@{/genres/{id}(id=${genre.genreId})}"
                           class="genre-link"
                           th:text="${genre.name}">
                           Genre Name
                        </a>
                        <span th:if="${!iter.last}">, </span>
                    </span>
                    <span th:if="${song.genres == null}">-</span>
                </td>

                <td class="col-views">
                    <span class="View" th:text="${song.views}">0</span>
                </td>

            </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container" th:if="${songs.totalPages > 0}">
        <div class="pagination">
            <a th:if="${songs.hasPrevious()}"
               th:href="@{/songs(title=${title}, artistId=${selectedArtistId}, albumId=${selectedAlbumId}, genreId=${selectedGenreId}, page=${songs.number - 1}, size=${pageSize})}"
               class="pagination-btn"
               hx-boost="true">
                <i class="fas fa-chevron-left"></i>
            </a>

            <span th:each="i : ${#numbers.sequence(0, songs.totalPages - 1)}">
                <a th:if="${i == songs.number}"
                   class="pagination-btn active"
                   th:text="${i + 1}">1</a>

                <a th:unless="${i == songs.number}"
                   th:href="@{/songs(title=${title}, artistId=${selectedArtistId}, albumId=${selectedAlbumId}, genreId=${selectedGenreId}, page=${i}, size=${pageSize})}"
                   class="pagination-btn"
                   th:text="${i + 1}"
                   hx-boost="true">2</a>
            </span>

            <a th:if="${songs.hasNext()}"
               th:href="@{/songs(title=${title}, artistId=${selectedArtistId}, albumId=${selectedAlbumId}, genreId=${selectedGenreId}, page=${songs.number + 1}, size=${pageSize})}"
               class="pagination-btn"
               hx-boost="true">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <div class="page-size-selector">
            <label>Show:</label>
            <select name="size"
                    hx-get="/songs"
                    hx-trigger="change"
                    hx-target="#main-content"
                    hx-select="#main-content"
                    hx-include=".filter-form">
                <option value="10" th:selected="${pageSize == 10}">10</option>
                <option value="20" th:selected="${pageSize == 20}">20</option>
                <option value="50" th:selected="${pageSize == 50}">50</option>
            </select>
        </div>
    </div>

    <style>
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #050505;
            background-image:
                    radial-gradient(at 0% 0%, rgba(1, 109, 110, 0.3) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(1, 60, 60, 0.5) 0px, transparent 50%),
                    radial-gradient(at 50% 50%, rgba(255, 255, 255, 0.02) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            min-height: 100vh;
            color: white;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: #E0FFFF;
            font-weight: 1000;
            text-shadow: 0 2px 10px rgba(224, 255, 255, 0.3);
        }

        .filter-bar {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            border: 1px solid rgba(224, 255, 255, 0.1);
        }

        .filter-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #00CED1;
            font-size: 0.9rem;
        }

        .filter-input {
            width: 80%;
            padding: 0.875rem 1rem 0.875rem 2.5rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            color: #E0FFFF;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #00CED1;
            background: rgba(0, 0, 0, 0.7);
            box-shadow: 0 0 0 3px rgba(0, 206, 209, 0.1);
        }

        .filter-input::placeholder {
            color: rgba(224, 255, 255, 0.4);
        }

        .filter-select {
            padding: 0.875rem 1rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 100px;
            color: #E0FFFF;
            font-size: 0.95rem;
            font-weight: 600;
            min-width: 160px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #00CED1;
            background: rgba(0, 0, 0, 0.7);
        }

        .filter-select option {
            background: #000;
            color: #E0FFFF;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: 100px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            border: none;
        }

        .btn-search {
            background: #00CED1;
            color: #000;
        }

        .btn-search:hover {
            background: #00E5E8;
            transform: translateY(-2px);
        }

        .btn-reset {
            background: rgba(255, 255, 255, 0.1);
            color: #E0FFFF;
            border: 1px solid rgba(224, 255, 255, 0.2);
        }

        .btn-reset:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #00CED1;
        }

        .songs-table-container {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid rgba(224, 255, 255, 0.1);
        }

        .songs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .songs-table thead {
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(224, 255, 255, 0.1);
        }

        .songs-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            color: rgba(224, 255, 255, 0.6);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .col-number { width: 60px; }
        .col-title { width: 29%; }
        .col-artist { width: 18%; }
        .col-album { width: 18%; text-align: left; }
        .col-genre { width: 25%; text-align: left; }
        .col-views { width: 10%; text-align: left; }

        .songs-table tbody tr {
            border-bottom: 1px solid rgba(224, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .songs-table tbody tr:hover {
            background: rgba(0, 206, 209, 0.1);
        }

        .songs-table td {
            padding: 0.75rem 1.5rem;
            color: #E0FFFF;
            vertical-align: middle;
        }

        .row-number {
            color: rgba(224, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .title-cell {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .song-cover {
            position: relative;
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .song-cover:hover img {
            transform: scale(1.1);
        }

        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
        }

        .song-cover:hover .play-overlay {
            opacity: 1;
        }

        .play-overlay i {
            color: #ffffff;
            font-size: 1rem;
            text-shadow:
                    0 0 10px rgba(255, 255, 255, 0.8),
                    0 0 20px rgba(255, 255, 255, 0.5),
                    0 0 30px rgba(255, 255, 255, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .song-cover:hover .play-overlay i {
            transform: scale(1.1);
            text-shadow:
                    0 0 15px rgba(255, 255, 255, 1),
                    0 0 30px rgba(255, 255, 255, 0.6);
        }

        .song-title-info {
            flex: 1;
            min-width: 0;
        }

        .song-name {
            font-size: 1rem;
            font-weight: 500;
            color: #E0FFFF;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 0.25rem;
        }

        .artist-link, .album-link, .song-link, .genre-link {
            color: rgba(224, 255, 255, 0.8);
            text-decoration: none !important;
            transition: color 0.3s ease;
        }

        .artist-link:hover, .album-link:hover, .song-link:hover, .genre-link:hover {
            color: #00CED1;
            text-decoration: underline !important;
        }

        .album-cell {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .album-cell i {
            color: #00CED1;
            font-size: 0.85rem;
        }

        .no-album {
            color: rgba(224, 255, 255, 0.3);
        }

        .View {
            color: rgba(224, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(224, 255, 255, 0.1);
        }

        .pagination {
            display: flex;
            gap: 0.5rem;
            padding-left: 40%;
            align-items: center;
        }

        .pagination-btn {
            padding: 0.625rem 0.875rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 10px;
            color: #E0FFFF;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .pagination-btn:hover {
            background: rgba(0, 206, 209, 0.2);
            border-color: #00CED1;
            transform: translateY(-2px);
        }

        .pagination-btn.active {
            background: #00CED1;
            color: #000;
            border-color: #00CED1;
            font-weight: 600;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(224, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .page-size-selector select {
            padding: 0.625rem 0.875rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 10px;
            color: #E0FFFF;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-size-selector select:focus {
            outline: none;
            border-color: #00CED1;
        }

        @media (max-width: 768px) {
            .filter-form {
                flex-direction: column;
            }
            .search-wrapper, .filter-select {
                width: 100%;
            }
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>

    <script>
        // ‚úÖ ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ <script type="application/json">
        function loadSongsData() {
            const dataElement = document.getElementById('songs-data');
            if (!dataElement) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y #songs-data");
                return [];
            }

            try {
                const jsonText = dataElement.textContent.trim();
                const songs = JSON.parse(jsonText);
                console.log("‚úÖ Loaded", songs.length, "songs from JSON");
                return songs;
            } catch (e) {
                console.error("‚ùå Parse JSON error:", e);
                return [];
            }
        }

        // ‚úÖ CACHE GLOBAL
        if (!window.allSongsData) {
            window.allSongsData = {};
        }

        // L∆∞u b√†i h√°t v√†o cache
        const currentPageSongs = loadSongsData();
        currentPageSongs.forEach(song => {
            window.allSongsData[song.songId] = song;
        });

        console.log("üìä Total cached songs:", Object.keys(window.allSongsData).length);

        // ‚úÖ KH·ªûI T·∫†O AUDIO PLAYER (1 L·∫¶N)
        if (!window.audioPlayerInitialized) {
            window.audioPlayerInitialized = true;

            const audio = document.getElementById('audioPlayer');
            window.currentSongId = null;
            window.isViewCounted = false;
            window.totalListeningTime = 0;
            window.lastTimePosition = 0;

            audio.addEventListener('timeupdate', function() {
                if (!window.currentSongId || window.isViewCounted) return;

                const timeDiff = this.currentTime - window.lastTimePosition;

                if (timeDiff > 0 && timeDiff < 1) {
                    window.totalListeningTime += timeDiff;
                }

                window.lastTimePosition = this.currentTime;

                if (window.totalListeningTime > 30) {
                    console.log("üéâ 30s reached ‚Üí increment view");
                    fetch(`/songs/${window.currentSongId}/increment-view`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(response => {
                        if (response.ok) {
                            const row = document.querySelector(`tr[data-song-id='${window.currentSongId}']`);
                            if (row) {
                                const viewCell = row.querySelector(".col-views span");
                                if (viewCell) {
                                    let views = parseInt(viewCell.innerText) || 0;
                                    viewCell.innerText = views + 1;
                                }
                            }
                        }
                    });
                    window.isViewCounted = true;
                }
            });

            audio.onended = () => {
                const icon = document.querySelector("#playPauseBtn i");
                if (icon) {
                    icon.classList.remove("fa-pause");
                    icon.classList.add("fa-play");
                }
            };

            audio.onplay = () => {
                const icon = document.querySelector("#playPauseBtn i");
                if (icon) {
                    icon.classList.remove("fa-play");
                    icon.classList.add("fa-pause");
                }
            };

            audio.onpause = () => {
                const icon = document.querySelector("#playPauseBtn i");
                if (icon) {
                    icon.classList.remove("fa-pause");
                    icon.classList.add("fa-play");
                }
            };
        }

        // ‚úÖ H√ÄM PH√ÅT NH·∫†C
        function playSong(songId) {
            const song = window.allSongsData[songId];

            if (!song) {
                console.error("‚ùå Song not found:", songId);
                console.log("üìã Available songs:", Object.keys(window.allSongsData));
                return;
            }

            if (!song.musicUrl) {
                alert("B√†i h√°t n√†y ch∆∞a c√≥ link nh·∫°c!");
                return;
            }

            const audio = document.getElementById('audioPlayer');

            window.currentSongId = song.songId;
            window.isViewCounted = false;
            window.totalListeningTime = 0;
            window.lastTimePosition = 0;

            audio.src = song.musicUrl;

            const titleEl = document.querySelector(".player-title");
            if (titleEl) titleEl.innerText = song.title;

            const artistEl = document.querySelector(".player-artist");
            if (artistEl) artistEl.innerText = song.artistName || "Unknown Artist";

            const coverEl = document.querySelector(".player-img");
            if (coverEl) coverEl.src = song.imageUrl || '/images/default-cover.png';

            audio.load();
            audio.currentTime = 0;

            audio.play().then(() => {
                window.lastTimePosition = audio.currentTime;
                console.log("‚ñ∂Ô∏è Playing:", song.title);
            }).catch(err => {
                console.error("‚ùå Play error:", err);
                alert("Kh√¥ng th·ªÉ ph√°t: " + err.message);
            });
        }

        // ‚úÖ G√ÅN EVENT LISTENER
        function attachPlayListeners() {
            document.querySelectorAll('.play-song-trigger').forEach(el => {
                el.replaceWith(el.cloneNode(true));
            });

            document.querySelectorAll('.play-song-trigger').forEach(el => {
                el.addEventListener('click', function() {
                    const songId = parseInt(this.getAttribute('data-song-id'));
                    console.log("üéµ Click play song ID:", songId);
                    playSong(songId);
                });
            });
        }

        attachPlayListeners();

        document.body.addEventListener('htmx:afterSwap', function() {
            // Load l·∫°i d·ªØ li·ªáu t·ª´ JSON m·ªõi
            const newSongs = loadSongsData();
            newSongs.forEach(song => {
                window.allSongsData[song.songId] = song;
            });
            console.log("üîÑ After swap - total cache:", Object.keys(window.allSongsData).length);

            attachPlayListeners();
        });
    </script>

</div>
</body>
</html>