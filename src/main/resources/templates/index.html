<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MusicPro - Trang chủ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        /* --- THEME SETUP --- */
        :root { --bg-body: #050505; --bg-card: #121212; --cyan-neon: #00f3ff; --green-neon: #00ff9d; --text-main: #fff; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        /* [UPDATE] SIDEBAR STYLES ĐỒNG BỘ */
        .sidebar { background: #000; border-right: 1px solid #333; transition: all 0.3s; }
        .nav-link { color: #b3b3b3; transition: 0.2s; font-weight: 500; padding: 10px 16px; border-radius: 4px; margin-bottom: 2px;}
        .nav-link:hover, .nav-link.active-tab { color: white; background-color: #282828; }
        .active-tab i { color: #1db954 !important; }

        /* Sidebar & Layout */
        .main-content { margin-left: 240px; min-height: 100vh; display: flex; flex-direction: column; }
        .top-header { background: rgba(5,5,5,0.95); position: sticky; top: 0; z-index: 900; padding: 15px 30px; border-bottom: 1px solid #1a1a1a; backdrop-filter: blur(10px); }

        /* Search Dropdown */
        .search-results-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a;
            border: 1px solid #333; border-radius: 0 0 8px 8px; z-index: 1000; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); max-height: 400px; overflow-y: auto;
        }
        .search-item:hover { background: #333; cursor: pointer; }

        /* Song Card Vertical */
        .song-card { background: var(--bg-card); border-radius: 6px; padding: 16px; transition: 0.3s; height: 100%; position: relative; }
        .song-card:hover { background: #282828; }
        .song-card img { border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); width: 100%; aspect-ratio: 1/1; object-fit: cover; margin-bottom: 12px; }

        /* Play Button Hover Effect */
        .play-overlay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 48px; height: 48px; background: var(--green-neon); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; color: black; font-size: 1.5rem; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        .song-card:hover .play-overlay { opacity: 1; transform: translate(-50%, -50%) scale(1); top: 40%; }

        /* Section Title */
        .section-title { font-weight: 700; font-size: 1.5rem; margin-bottom: 20px; color: white; }
        .section-link { float: right; font-size: 0.85rem; text-decoration: none; color: #b3b3b3; font-weight: 600; margin-top: 8px; text-transform: uppercase; }
        .section-link:hover { color: white; text-decoration: underline; }

        /* Actions Bar inside Card */
        .card-actions { display: flex; justify-content: space-between; margin-top: 10px; color: #b3b3b3; opacity: 0; transition: 0.3s; }
        .song-card:hover .card-actions { opacity: 1; }
        .action-btn:hover { color: white; transform: scale(1.1); }
        .active-like { color: var(--green-neon) !important; }
    </style>
</head>
<body>

<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="main-content">

    <div class="top-header d-flex justify-content-between align-items-center">
        <div class="position-relative" style="width: 400px;">
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-secondary rounded-start-pill ps-3"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control bg-dark border-secondary text-white rounded-end-pill"
                       placeholder="Tìm bài hát, nghệ sĩ, album..." onkeyup="debounceSearch()">
            </div>
            <div id="searchResults" class="search-results-dropdown p-2"></div>
        </div>

        <div class="d-flex align-items-center gap-3">
            <a id="admin-link-li" href="/admin/dashboard" class="text-decoration-none fw-bold small text-warning" style="display: none;">
                <i class="bi bi-shield-lock-fill"></i> ADMIN
            </a>
            <div class="text-end lh-1">
                <small class="text-white-50" style="font-size: 0.7em">USER ID</small>
                <div class="fw-bold text-info" id="display-uid">--</div>
            </div>
            <img src="https://placehold.co/40" class="rounded-circle border border-secondary cursor-pointer" onclick="changeUser()">
        </div>
    </div>

    <div class="container-fluid py-4 px-5 flex-grow-1">

        <div class="mb-5">
            <h4 class="section-title">Gợi ý cho bạn</h4>
            <div id="loading-rec" class="text-center"><div class="spinner-border text-info"></div></div>
            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4" id="recommend-list"></div>
        </div>

        <div class="mb-5">
            <a href="#" class="section-link">Tất cả <i class="bi bi-chevron-right"></i></a>
            <h4 class="section-title">Mới Phát Hành</h4>
            <div class="row g-3" id="new-release-list">
            </div>
        </div>

        <div class="mb-5">
            <h4 class="section-title text-warning">Top Trending <i class="bi bi-graph-up-arrow ms-2"></i></h4>
            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="trending-list"></div>
        </div>

    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<div th:replace="~{fragments/sidebar :: create-playlist-modal}"></div>

<div class="modal fade" id="playlistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">Thêm vào Playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalSongId">
                <div id="playlist-opts" class="list-group list-group-flush"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title"><span id="cmt-song-title" class="fw-bold text-info">Song Title</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cmt-song-id">
                <div class="card bg-black border-secondary mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Đánh giá:</strong>
                            <div class="mt-1" id="star-rating-area">
                                <i class="bi bi-star text-secondary fs-4 cursor-pointer" onclick="setRating(1)"></i>
                                <i class="bi bi-star text-secondary fs-4 cursor-pointer" onclick="setRating(2)"></i>
                                <i class="bi bi-star text-secondary fs-4 cursor-pointer" onclick="setRating(3)"></i>
                                <i class="bi bi-star text-secondary fs-4 cursor-pointer" onclick="setRating(4)"></i>
                                <i class="bi bi-star text-secondary fs-4 cursor-pointer" onclick="setRating(5)"></i>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="submitRating()">Gửi Đánh Giá</button>
                    </div>
                </div>
                <h6 class="text-muted small border-bottom border-secondary pb-2">BÌNH LUẬN</h6>
                <div id="comment-list-area" style="max-height: 300px; overflow-y: auto;"></div>
                <div class="mt-3 d-flex gap-2">
                    <input type="text" id="new-comment-content" class="form-control bg-black text-white border-secondary" placeholder="Viết bình luận...">
                    <button class="btn btn-info" onclick="postComment()">Gửi</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger bg-dark text-white">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-danger"><i class="bi bi-shield-exclamation me-2"></i>BÁO CÁO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mục tiêu: <strong id="report-target-name">...</strong></p>
                <input type="hidden" id="report-target-id"><input type="hidden" id="report-type">
                <select id="report-reason" class="form-select mb-3 bg-black text-white border-secondary">
                    <option value="Spam">Spam / Rác</option>
                    <option value="Ngôn từ đả kích">Ngôn từ đả kích</option>
                    <option value="Bản quyền">Bản quyền</option>
                </select>
                <div class="d-grid"><button class="btn btn-danger" onclick="submitReport()">GỬI BÁO CÁO</button></div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="msgToast" class="toast align-items-center text-white bg-black border border-success" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-text" style="color: var(--green-neon)">Success</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const API = "/api";
    let USER_ID = localStorage.getItem('music_user_id') || 1;
    document.getElementById('display-uid').innerText = USER_ID;
    let searchTimeout = null;
    let sidebarPlaylistsData = []; // Cache dữ liệu
    let isSidebarExpanded = false; // Trạng thái đóng/mở

    // --- 1. ADMIN CHECK ---
    async function checkAdminRole() {
        try {
            const res = await fetch(`${API}/users/${USER_ID}`);
            if (res.ok) {
                const user = await res.json();
                if(user.role === 'ADMIN') document.getElementById('admin-link-li').style.display = 'block';
            }
        } catch (e) {}
    }

    // --- 2. LOGIC TÌM KIẾM ---
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(doSearch, 400);
    }
    async function doSearch() {
        const keyword = document.getElementById('searchInput').value.trim();
        const resultBox = document.getElementById('searchResults');
        if(keyword.length < 2) { resultBox.style.display = 'none'; return; }

        try {
            // Gọi API SearchController mới
            const res = await fetch(`${API}/search?keyword=${encodeURIComponent(keyword)}`);
            const data = await res.json();

            let html = '';
            if(data.songs && data.songs.length > 0) {
                html += '<div class="text-muted small fw-bold px-2 py-1">BÀI HÁT</div>';
                data.songs.forEach(s => {
                    html += `
                    <div class="search-item d-flex align-items-center p-2 rounded" onclick="window.location.href='/song/${s.songId}'">
                        <img src="${s.coverImage || 'https://placehold.co/40'}" width="40" height="40" class="rounded me-3 object-fit-cover">
                        <div>
                            <div class="text-white fw-bold small">${s.title}</div>
                            <div class="text-white-50 small" style="font-size: 0.75rem">${s.artist ? s.artist.name : 'Unknown'}</div>
                        </div>
                    </div>`;
                });
            }
            if(data.playlists && data.playlists.length > 0) {
                html += '<div class="text-muted small fw-bold px-2 py-1 mt-2">PLAYLIST</div>';
                data.playlists.forEach(p => {
                    html += `
                    <div class="search-item d-flex align-items-center p-2 rounded" onclick="window.location.href='/playlist/${p.playlistId}'">
                        <img src="${p.imageUrl || 'https://placehold.co/40'}" width="40" height="40" class="rounded me-3 object-fit-cover">
                        <div class="text-white fw-bold small">${p.name}</div>
                    </div>`;
                });
            }
            if(html === '') html = '<div class="p-3 text-center text-muted">Không tìm thấy kết quả</div>';
            resultBox.innerHTML = html;
            resultBox.style.display = 'block';
        } catch(e) { console.error(e); }
    }
    document.addEventListener('click', (e) => { if (!e.target.closest('.position-relative')) document.getElementById('searchResults').style.display = 'none'; });

    // --- 3. LOAD DASHBOARD (PHÂN LOẠI) ---
    async function loadDashboard() {
        try {
            const res = await fetch(`${API}/dashboard/${USER_ID}`);
            const data = await res.json();
            document.getElementById('loading-rec').style.display = 'none';

            // Gợi ý
            renderCardGrid(data.recommendedSongs, 'recommend-list');
            // Mới phát hành
            renderHorizontalList(data.newReleases, 'new-release-list');
            // Trending
            renderCardGrid(data.trendingSongs, 'trending-list');

        } catch(e) { console.error(e); }
    }

    // Render Dạng Lưới (Dọc) - Có đầy đủ nút chức năng cũ
    function renderCardGrid(list, containerId) {
        const container = document.getElementById(containerId);
        if(!list || list.length === 0) return;
        list.forEach(s => {
            container.innerHTML += `
            <div class="col">
                <div class="song-card">
                    <div style="position: relative;">
                         <img src="${s.coverImage || 'https://placehold.co/200'}" loading="lazy">
                         <div class="play-overlay cursor-pointer" onclick="window.location.href='/song/${s.songId}'"><i class="bi bi-play-fill"></i></div>
                    </div>
                    <div class="mb-2">
                        <h6 class="text-truncate mb-0 text-white fw-bold" title="${s.title}">${s.title}</h6>
                        <small class="text-white-50 text-truncate d-block">${s.artist ? s.artist.name : 'Unknown'}</small>
                    </div>
                    <div class="card-actions">
                        <i class="bi bi-heart-fill action-btn cursor-pointer" onclick="toggleLike(this, ${s.songId})" title="Like"></i>
                        <i class="bi bi-chat-left-dots-fill action-btn cursor-pointer" onclick="openCommentModal(${s.songId}, '${s.title}')"></i>
                        <i class="bi bi-plus-square-fill action-btn cursor-pointer" onclick="openPlaylistModal(${s.songId})"></i>
                        <i class="bi bi-flag-fill action-btn cursor-pointer" onclick="openReportModal(${s.songId}, 'SONG', '${s.title}')"></i>
                    </div>
                </div>
            </div>`;
        });
    }

    // Render Dạng Ngang (Cho Mới phát hành)
    function renderHorizontalList(list, containerId) {
        const container = document.getElementById(containerId);
        if(!list || list.length === 0) return;
        list.forEach(s => {
            container.innerHTML += `
            <div class="col-12 col-md-6 col-lg-4">
                <div class="d-flex align-items-center bg-dark p-2 rounded border border-secondary border-opacity-25 hover-bg-secondary" style="transition:0.2s">
                    <img src="${s.coverImage || 'https://placehold.co/60'}" width="60" height="60" class="rounded me-3 object-fit-cover">
                    <div class="flex-grow-1 overflow-hidden cursor-pointer" onclick="window.location.href='/song/${s.songId}'">
                        <h6 class="mb-0 text-truncate fw-bold text-white">${s.title}</h6>
                        <small class="text-muted">${s.artist ? s.artist.name : 'Unknown'}</small>
                    </div>
                    <div class="d-flex gap-2 ms-2">
                        <i class="bi bi-heart text-secondary cursor-pointer" onclick="toggleLike(this, ${s.songId})"></i>
                        <i class="bi bi-three-dots text-secondary cursor-pointer" onclick="openReportModal(${s.songId}, 'SONG', '${s.title}')"></i>
                    </div>
                </div>
            </div>`;
        });
    }

    // --- 4. CÁC HÀM CHỨC NĂNG CŨ (GIỮ NGUYÊN) ---
    async function toggleLike(el, sid) {
        const res = await fetch(`${API}/favorites/toggle?userId=${USER_ID}&songId=${sid}`, {method: 'POST'});
        const txt = await res.text();
        if(txt.includes('Liked')) { el.classList.add('active-like', 'text-success'); showToast('Đã thích'); }
        else { el.classList.remove('active-like', 'text-success'); showToast('Bỏ thích'); }
    }

    // Playlist Logic
    async function openPlaylistModal(sid) {
        const modal = new bootstrap.Modal(document.getElementById('playlistModal'));
        document.getElementById('modalSongId').value = sid;
        const res = await fetch(`${API}/playlists/user/${USER_ID}`);
        const playlists = await res.json();
        const div = document.getElementById('playlist-opts');
        div.innerHTML = '';
        playlists.forEach(p => div.innerHTML += `<button class="list-group-item list-group-item-action bg-black text-white border-secondary" onclick="addToPlaylist(${p.playlistId}, ${sid})">${p.name}</button>`);
        modal.show();
    }
    async function addToPlaylist(pid, sid) {
        await fetch(`${API}/playlists/${pid}/songs`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({songId: sid})});
        showToast('Đã thêm vào Playlist');
        bootstrap.Modal.getInstance(document.getElementById('playlistModal')).hide();
    }

    // Comment Logic
    async function openCommentModal(sid, title) {
        document.getElementById('cmt-song-title').innerText = title;
        document.getElementById('cmt-song-id').value = sid;
        await loadComments(sid);
        new bootstrap.Modal(document.getElementById('commentModal')).show();
    }
    async function loadComments(sid) {
        const container = document.getElementById('comment-list-area');
        container.innerHTML = 'Loading...';
        const res = await fetch(`${API}/comments/song/${sid}`);
        const comments = await res.json();
        container.innerHTML = '';
        comments.forEach(c => container.innerHTML += `<div class="border-bottom border-secondary py-2"><strong class="text-info">${c.user.username}</strong>: ${c.content}</div>`);
    }
    async function postComment() {
        const content = document.getElementById('new-comment-content').value;
        const sid = document.getElementById('cmt-song-id').value;
        if(!content) return;
        await fetch(`${API}/comments/add`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: USER_ID, songId: sid, content: content})});
        document.getElementById('new-comment-content').value = '';
        loadComments(sid);
    }

    // Rating & Report Logic (Giữ nguyên)
    let currentRating = 0;
    function setRating(star) {
        currentRating = star;
        document.querySelectorAll('#star-rating-area i').forEach((s, idx) => s.classList.toggle('text-warning', idx < star));
    }
    async function submitRating() {
        const sid = document.getElementById('cmt-song-id').value;
        if(currentRating===0) return alert("Chọn số sao!");
        await fetch(`${API}/ratings`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: USER_ID, songId: sid, rating: currentRating})});
        alert("Đã đánh giá!");
    }

    function openReportModal(tid, type, name) {
        document.getElementById('report-target-id').value = tid;
        document.getElementById('report-type').value = type;
        document.getElementById('report-target-name').innerText = name;
        new bootstrap.Modal(document.getElementById('reportModal')).show();
    }
    async function submitReport() {
        const body = {
            reporterId: USER_ID, targetId: document.getElementById('report-target-id').value,
            type: document.getElementById('report-type').value, reason: document.getElementById('report-reason').value
        };
        await fetch(`${API}/reports/create`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
        showToast('Đã gửi báo cáo');
        bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
    }

    function showToast(msg) {
        document.getElementById('toast-text').innerText = msg;
        new bootstrap.Toast(document.getElementById('msgToast')).show();
    }
    function changeUser() {
        let u = prompt("USER ID:", USER_ID);
        if(u) { localStorage.setItem('music_user_id', u); location.reload(); }
    }

    // Load Sidebar
    async function loadSidebarPlaylists() {
        try {
            const res = await fetch(`${API}/playlists/user/${USER_ID}`);
            if(res.ok) {
                const data = await res.json();
                // Sắp xếp: Mới nhất lên đầu
                sidebarPlaylistsData = data.sort((a, b) => b.playlistId - a.playlistId);
                renderSidebarUI();
            }
        } catch(e) { console.error("Sidebar load err", e); }
    }

    function renderSidebarUI() {
        const container = document.getElementById('sidebar-playlists');
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(!container) return;

        container.innerHTML = '';

        // Logic hiển thị 5 hoặc tất cả
        const limit = isSidebarExpanded ? sidebarPlaylistsData.length : 5;
        const displayList = sidebarPlaylistsData.slice(0, limit);

        displayList.forEach(p => {
            container.innerHTML += `
                <a href="/playlist/${p.playlistId}" class="nav-link text-truncate py-2 text-white-50" style="font-size: 0.9rem;">
                    <i class="bi bi-music-note-list"></i> ${p.name}
                </a>`;
        });

        // Xử lý nút Xem thêm / Thu gọn
        if (sidebarPlaylistsData.length > 5) {
            btnExpand.classList.remove('d-none');
            if (isSidebarExpanded) {
                btnExpand.innerHTML = 'Thu gọn <i class="bi bi-chevron-up ms-1"></i>';
            } else {
                btnExpand.innerHTML = `Xem thêm (${sidebarPlaylistsData.length - 5}) <i class="bi bi-chevron-down ms-1"></i>`;
            }
        } else {
            btnExpand.classList.add('d-none');
        }
    }

    // Gán sự kiện click cho nút Xem thêm (Chỉ gán 1 lần khi DOM load)
    document.addEventListener('DOMContentLoaded', () => {
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(btnExpand) {
            btnExpand.addEventListener('click', () => {
                isSidebarExpanded = !isSidebarExpanded;
                renderSidebarUI();
            });
        }

        // Gán sự kiện nút Tạo Playlist (đã có ở code cũ, nhưng gom vào đây cho gọn)
        const btnCreate = document.getElementById('btn-create-playlist');
        if(btnCreate) {
            btnCreate.addEventListener('click', () => {
                document.getElementById('newPlName').value = '';
                new bootstrap.Modal(document.getElementById('createPlModal')).show();
            });
        }
    });

    // Hàm tạo Playlist (Cần gọi lại loadSidebarPlaylists sau khi tạo xong)
    async function createPlaylist() {
        const name = document.getElementById('newPlName').value;
        const isPublic = document.getElementById('isPublicCheck').checked;
        if(!name) return alert("Vui lòng nhập tên Playlist");
        try {
            await fetch(`${API}/playlists`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ userId: USER_ID, name: name, isPublic: isPublic })
            });
            alert("Tạo thành công!");
            bootstrap.Modal.getInstance(document.getElementById('createPlModal')).hide();

            // Reload lại dữ liệu và render lại
            loadSidebarPlaylists();
        } catch (e) { console.error(e); }
    }

    // INIT
    checkAdminRole();
    loadDashboard();
    loadSidebarPlaylists();
</script>
<script src="/js/global-player.js"></script>
</body>
</html>