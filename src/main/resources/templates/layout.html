<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Music App'">Music App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 240px;
            --primary: #00f3ff;
            --bg-dark: #0a0a0a;
            --bg-sidebar: #000000;
            --bg-card: #111111;
            --text-main: #ffffff;
            --text-gray: #b3b3b3;
            --border-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            padding: 24px;
            position: fixed;
            height: 100vh;
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(224, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: #E0FFFF;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 2px 10px rgba(224, 255, 255, 0.3);
        }

        .navbar-brand:hover {
            transform: translateY(-2px);
            text-shadow: 0 4px 20px rgba(224, 255, 255, 0.5);
        }

        .navbar-brand i {
            filter: drop-shadow(0 0 8px rgba(224, 255, 255, 0.6));
        }

        .navbar-menu {
            display: flex;
            gap: 1rem;
            list-style: none;
            align-items: center;
        }

        .navbar-item a {
            color: rgba(224, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0.6rem 1.2rem;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .navbar-item a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(224, 255, 255, 0.1) 0%, rgba(224, 255, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 12px;
        }

        .navbar-item a:hover {
            color: #E0FFFF;
            transform: translateY(-2px);
            text-shadow: 0 0 10px rgba(224, 255, 255, 0.4);
        }

        .navbar-item a:hover::before {
            opacity: 1;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-gray);
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .menu-item:hover, .menu-item.active {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            border-left: 3px solid var(--primary);
        }

        .menu-icon { margin-right: 15px; font-size: 20px; width: 25px; text-align: center; }

        .library-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .lib-title { font-size: 12px; text-transform: uppercase; color: var(--text-gray); margin-bottom: 15px; letter-spacing: 1px; }

        /* MAIN CONTENT WRAPPER */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            flex: 1;
            width: calc(100% - var(--sidebar-width));
            background: linear-gradient(180deg, #1a1a1a 0%, var(--bg-dark) 40%);
            padding-bottom: 100px; /* Space for player */
            min-height: 100vh;
        }

        .content-container {
            padding: 20px 40px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* HEADER (Search + User) */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 40px;
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            z-index: 900;
        }

        .search-bar {
            background: #2a2a2a;
            border-radius: 20px;
            padding: 10px 20px;
            width: 400px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid transparent;
            transition: 0.3s;
        }
        .search-bar:focus-within { border-color: var(--primary); }
        .search-input { background: transparent; border: none; color: white; width: 100%; outline: none; }

        .auth-buttons { display: flex; gap: 15px; align-items: center; }
        .btn-login {
            background: var(--primary); color: black; padding: 8px 25px;
            border-radius: 20px; font-weight: bold; text-decoration: none; transition: 0.3s;
        }
        .btn-login:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }

        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; text-decoration: none; color: white; }
        .avatar { width: 35px; height: 35px; background: #555; border-radius: 50%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* MUSIC PLAYER BAR (Gi·ªØ nguy√™n style c≈© c·ªßa b·∫°n) */
        .music-player {
            position: fixed; bottom: 0; left: 0; right: 0; height: 90px;
            background-color: #181818; border-top: 1px solid #282828;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2rem; z-index: 2000;
        }
        /* ... (C√°c class player c≈© gi·ªØ nguy√™n) ... */
        .player-info { display: flex; align-items: center; gap: 15px; width: 30%; }
        .player-img { width: 60px; height: 60px; border-radius: 4px; object-fit: cover; }
        .player-controls { display: flex; flex-direction: column; align-items: center; width: 40%; gap: 5px; }
        .controls-buttons { display: flex; gap: 20px; align-items: center; font-size: 1.2rem; }
        .control-btn { background: none; border: none; color: #b3b3b3; cursor: pointer; transition: 0.2s; }
        .control-btn:hover { color: white; }
        .control-btn.play-pause { width: 35px; height: 35px; background: white; color: black; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; }
        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #b3b3b3; }
        .progress-bar { flex: 1; height: 4px; background: #444; border-radius: 2px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 2px; width: 0%; position: relative; }
        .progress-fill::after { content: ''; position: absolute; right: -6px; top: -4px; width: 12px; height: 12px; background: white; border-radius: 50%; opacity: 0; transition: 0.2s; }
        .progress-bar:hover .progress-fill::after { opacity: 1; }
        .volume-control { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .volume-slider { width: 100px; height: 4px; background: #444; border-radius: 2px; cursor: pointer; }
        .volume-fill { height: 100%; background: #b3b3b3; width: 100%; }


        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* --- MUSIC PLAYER BAR CSS --- */
        .music-player {
            position: fixed;
            bottom: 0;
            left: 0px; /* Kh·ªõp v·ªõi ƒë·ªô r·ªông sidebar */
            right: 0;    /* K√©o d√†i h·∫øt sang ph·∫£i */
            height: 90px;
            background-color: #181818;
            border-top: 1px solid #282828;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 1000; /* ƒê·∫£m b·∫£o n·ªïi l√™n tr√™n c√°c th√†nh ph·∫ßn kh√°c */
        }

        /* Ph·∫ßn th√¥ng tin b√†i h√°t */
        .song-info {
            display: flex;
            align-items: center;
            width: 30%; /* Chi·∫øm 30% chi·ªÅu r·ªông */
        }
        .player-img {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 1rem;
            object-fit: cover;
        }
        .song-details .player-title {
            color: #fff;
            font-size: 1rem;
            margin: 0;
            font-weight: 500;
        }
        .song-details .player-artist {
            color: #b3b3b3;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Ph·∫ßn n√∫t ƒëi·ªÅu khi·ªÉn ·ªü gi·ªØa */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .control-btn {
            background: none;
            border: none;
            color: #b3b3b3;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .control-btn:hover {
            color: #fff;
        }
        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff; /* N√∫t play tr√≤n m√†u tr·∫Øng */
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        .play-btn:hover {
            transform: scale(1.1);
            color: #000;
        }

        .player-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 2rem;
            align-items: center;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: fadeInLeft 0.5s ease;
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4),
            0 0 20px rgba(224, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .player-cover:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5),
            0 0 30px rgba(224, 255, 255, 0.2);
        }

        .player-details h4 {
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
            color: #E0FFFF;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(224, 255, 255, 0.2);
        }

        .player-details p {
            font-size: 0.85rem;
            color: rgba(224, 255, 255, 0.5);
            font-weight: 300;
        }

        .controls-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.2rem;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.play-pause {
            background: linear-gradient(135deg, #E0FFFF 0%, #a0e0e0 100%);
            color: #000;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(224, 255, 255, 0.3);
        }

        .control-btn.play-pause:hover {
            background: linear-gradient(135deg, #ffffff 0%, #E0FFFF 100%);
            box-shadow: 0 6px 25px rgba(224, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px; /* QUAN TR·ªåNG: Gi·∫£m t·ª´ 100px xu·ªëng 15px */
            width: 100%; /* ƒê·∫£m b·∫£o khung bao r·ªông h·∫øt c·ª° */
            padding: 0 10px;
        }

        .progress-time {
            font-size: 15px;
            color: #ccc;
            min-width: 40px;
            text-align: center;
        }

        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #555555; /* M√†u x√°m s√°ng h∆°n ch√∫t ƒë·ªÉ d·ªÖ nh√¨n */
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: visible; /* ƒê·ªÉ hi·ªán ch·∫•m tr√≤n */

            /* Th√™m min-width ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ kh√¥ng bao gi·ªù bi·∫øn m·∫•t */
            min-width: 150px;
        }



        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-bar:hover {
            height: 6px;
            background: rgba(224, 255, 255, 0.15);
        }



        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #E0FFFF 0%, #a0e0e0 100%);

            background-color: #00ffff;
            border-radius: 3px;
            position: relative;
            /* transition: width 0.1s linear; -> T·∫°m b·ªè transition khi debug ƒë·ªÉ k√©o m∆∞·ª£t h∆°n */
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -7px; /* CƒÉn ch·ªânh l·∫°i cho c√¢n (14px / 2) */
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(224, 255, 255, 0.4);
            z-index: 10;
        }

        .player-extras {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1.2rem;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            background: rgba(224, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .volume-slider:hover {
            height: 6px;
            background: rgba(224, 255, 255, 0.15);
        }

        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #E0FFFF 0%, #a0e0e0 100%);
            border-radius: 10px;
            width: 70%;
            box-shadow: 0 0 10px rgba(224, 255, 255, 0.4);
        }

        .extra-btn {
            background: none;
            border: none;
            color: rgba(224, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0.5rem;
            border-radius: 50%;
        }

        .extra-btn:hover {
            color: #E0FFFF;
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(224, 255, 255, 0.4));
        }

        .extra-btn.active {
            color: #E0FFFF;
            filter: drop-shadow(0 0 10px rgba(224, 255, 255, 0.6));
        }


        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Banner */
        .banner {
            background: linear-gradient(90deg, #ff3366, #ff6b6b);
            height: 200px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }
        .banner h1 { font-size: 40px; font-weight: 800; margin-bottom: 10px; }
        .banner p { max-width: 600px; color: rgba(255,255,255,0.9); }

        /* Sections (Song Cards) */
        h2 { margin-bottom: 20px; font-size: 24px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 40px; }

        .song-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
        }
        .song-card:hover { background: #282828; }

        .card-img {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #333; /* Placeholder m√†u x√°m */
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
            display: flex; justify-content: center; align-items: center; color: #555; font-size: 3rem;
        }

        .card-title { font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-desc { color: var(--text-gray); font-size: 14px; }

        /* Play Button Overlay */
        .play-btn {
            position: absolute; bottom: 10px; right: 10px;
            width: 40px; height: 40px; background: var(--primary); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .song-card:hover .play-btn { opacity: 1; bottom: 15px; }
    </style>
    <th:block layout:fragment="extra-css"></th:block>
</head>
<body>

<div class="sidebar">
    <a href="/" class="logo"><span>üéµ</span> Music AI</a>

    <a href="/" class="menu-item" th:classappend="${activeTab == 'home'} ? 'active'">
        <span class="menu-icon">üè†</span> Kh√°m Ph√°
    </a>
    <a href="/ranking" class="menu-item" th:classappend="${activeTab == 'ranking'} ? 'active'">
        <span class="menu-icon">üìà</span> B·∫£ng X·∫øp H·∫°ng
    </a>
    <a href="/gemini" class="menu-item" th:classappend="${activeTab == 'ai-dj'} ? 'active'">
        <span class="menu-icon">ü§ñ</span> G·ª£i √Ω b√†i h√°t
    </a>

    <div class="library-section">
        <div class="lib-title">Th∆∞ vi·ªán</div>
        <a href="/history" class="menu-item" th:classappend="${activeTab == 'history'} ? 'active'">
            <span class="menu-icon">üï∞Ô∏è</span> Nghe g·∫ßn ƒë√¢y
        </a>
        <a href="/favorites" class="menu-item" th:classappend="${activeTab == 'favorites'} ? 'active'">
            <span class="menu-icon">‚ù§Ô∏è</span> B√†i h√°t y√™u th√≠ch
        </a>
        <a href="/playlists" class="menu-item" th:classappend="${activeTab == 'playlists'} ? 'active'">
            <span class="menu-icon">üìÇ</span> Playlist c·ªßa t√¥i
        </a>
    </div>
</div>

<div class="main-wrapper">
    <div class="top-header">
        <div class="search-bar">
            <span>üîç</span>
            <input type="text" class="search-input" placeholder="T√¨m ki·∫øm b√†i h√°t, ngh·ªá sƒ©...">
        </div>

        <ul class="navbar-menu">
            <li class="navbar-item"><a href="/songs">Songs</a></li>
            <li class="navbar-item"><a href="/admin/manager">Admin</a></li>
        </ul>

        <div class="auth-buttons">

            <div th:if="${!isLoggedIn}">
                <a href="/register" style="color: #b3b3b3; font-weight: bold; margin-right: 20px;">ƒêƒÉng k√Ω</a>
                <a href="/login" class="btn-login">ƒêƒÉng nh·∫≠p</a>
            </div>

            <div th:if="${isLoggedIn}" class="user-profile">
                <a th:if="${isAdmin}" href="/admin/dashboard" style="color: var(--primary); border: 1px solid var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; margin-right: 10px;">
                    ‚ö° Admin
                </a>

                <div th:if="${isLoggedIn}" class="user-profile">
                    <a href="/profile" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                        <span th:text="${username}">User</span>
                        <div class="avatar"><img src="/images/default-avatar.png" alt="AVT"></div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="content-container" layout:fragment="content">
    </div>
</div>

<div class="music-player" id="musicPlayer">
    <audio id="audioPlayer"></audio>
    <div class="player-info">
        <img src="https://via.placeholder.com/60" class="player-img" id="playerCover">
        <div>
            <h4 style="margin:0; font-size:0.95rem; color:white;" id="playerTitle">Ch·ªçn b√†i h√°t</h4>
            <p style="margin:0; font-size:0.8rem; color:#b3b3b3;" id="playerArtist">-</p>
        </div>
        <i class="far fa-heart" style="cursor: pointer; margin-left: 10px; color: var(--primary);"></i>
    </div>
    <div class="player-controls">
        <div class="controls-buttons">
            <button class="control-btn" title="Tr·ªôn b√†i"><i class="fas fa-random"></i></button>
            <button class="control-btn" title="Tr∆∞·ªõc"><i class="fas fa-step-backward"></i></button>
            <button class="control-btn play-pause" id="playPauseBtn" onclick="togglePlay()">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-btn" title="Sau"><i class="fas fa-step-forward"></i></button>
            <button class="control-btn" title="L·∫∑p l·∫°i"><i class="fas fa-redo"></i></button>
        </div>
        <div class="progress-container">
            <span id="currentTime">0:00</span>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span id="totalTime">0:00</span>
        </div>
    </div>
    <div class="volume-control">
        <i class="fas fa-volume-up"></i>
        <div class="volume-slider">
            <div class="volume-fill"></div>
        </div>
    </div>
</div>

<script>
    // GLOBAL PLAYER LOGIC (Gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
    const audio = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playPauseBtn');
    let isPlaying = false;

    function togglePlay() {
        if (!audio.src) return;
        if (audio.paused) {
            audio.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
        } else {
            audio.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
        }
    }

    // H√†m g·ªçi t·ª´ c√°c trang con
    window.playGlobalSong = function(url, title, artist, cover) {
        if(!url) return alert("B√†i h√°t ch∆∞a c√≥ link nh·∫°c!");
        audio.src = url;
        document.getElementById('playerTitle').innerText = title || "Unknown Title";
        document.getElementById('playerArtist').innerText = artist || "Unknown Artist";
        document.getElementById('playerCover').src = cover || '/images/default.png';
        audio.play();
        playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
    };

    // Update progress bar
    audio.addEventListener('timeupdate', () => {
        const percent = (audio.currentTime / audio.duration) * 100;
        document.getElementById('progressFill').style.width = percent + '%';
        // Format time logic here...
    });

    let searchTimeout = null;

    async function handleSearch(keyword) {
        const resultBox = document.getElementById('searchResultsDropdown');

        // 1. N·∫øu t·ª´ kh√≥a qu√° ng·∫Øn th√¨ ·∫©n dropdown
        if (!keyword || keyword.length < 2) {
            resultBox.style.display = 'none';
            resultBox.innerHTML = '';
            return;
        }

        // 2. Debounce (ch·ªù ng∆∞·ªùi d√πng g√µ xong m·ªõi g·ªçi API)
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                // 3. G·ªçi Controller b·∫±ng Fetch API
                const response = await fetch(`/search/fragment?keyword=${encodeURIComponent(keyword)}`);

                if (response.ok) {
                    const html = await response.text();
                    resultBox.innerHTML = html; // ƒêi·ªÅn Fragment v√†o div
                    resultBox.style.display = 'block'; // Hi·ªán dropdown
                }
            } catch (error) {
                console.error("L·ªói t√¨m ki·∫øm:", error);
            }
        }, 300); // Ch·ªù 300ms
    }

    // ·∫®n dropdown khi click ra ngo√†i
    document.addEventListener('click', function(e) {
        const searchBar = document.querySelector('.search-bar');
        if (!searchBar.contains(e.target)) {
            document.getElementById('searchResultsDropdown').style.display = 'none';
        }
    });


    // 2. L·∫ÆNG NGHE S·ª∞ KI·ªÜN T·ª∞ ƒê·ªòNG (S·ª≠a l·ªói c·ªßa b·∫°n t·∫°i ƒë√¢y)
    // H·ªÖ nh·∫°c b·∫Øt ƒë·∫ßu ch·∫°y -> T·ª± ƒë·ªông ƒë·ªïi icon th√†nh Pause
    audio.onplay = function() {
        isPlaying = true;
        updateIcon(true);
    };

    // H·ªÖ nh·∫°c d·ª´ng -> T·ª± ƒë·ªông ƒë·ªïi icon th√†nh Play
    audio.onpause = function() {
        isPlaying = false;
        updateIcon(false);
    };

    // H·ªÖ nh·∫°c h·∫øt -> T·ª± ƒë·ªông ƒë·ªïi icon th√†nh Play
    audio.onended = function() {
        isPlaying = false;
        updateIcon(false);
    };

    audio.ontimeupdate = () => {
        if(audio.duration) {
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressFill').style.width = pct + "%";
            document.getElementById('currentTime').innerText = formatTime(audio.currentTime);
            document.getElementById('totalTime').innerText = formatTime(audio.duration);
        }
    };

    // 3. H√†m b·∫≠t/t·∫Øt nh·∫°c khi b·∫•m n√∫t ·ªü thanh player
    function togglePlay() {
        if (!audio.src || audio.src === "") return;

        if (audio.paused) {
            audio.play();
            // Kh√¥ng c·∫ßn g·ªçi updateIcon(true) ·ªü ƒë√¢y n·ªØa v√¨ audio.onplay s·∫Ω t·ª± lo
        } else {
            audio.pause();
            // Kh√¥ng c·∫ßn g·ªçi updateIcon(false) ·ªü ƒë√¢y n·ªØa v√¨ audio.onpause s·∫Ω t·ª± lo
        }
    }

    // 4. H√†m c·∫≠p nh·∫≠t h√¨nh ·∫£nh Icon
    function updateIcon(playing) {
        const icon = document.querySelector("#playPauseBtn i");
        if(icon) {
            if(playing) {
                // ƒêang ph√°t -> Hi·ªán n√∫t Pause (2 g·∫°ch)
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                // ƒêang d·ª´ng -> Hi·ªán n√∫t Play (tam gi√°c)
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }
        }
    }



    // --- B·ªî SUNG LOGIC THANH TI·∫æN TR√åNH ---

    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');

    // 1. S·ª± ki·ªán khi tr√¨nh duy·ªát t·∫£i ƒë∆∞·ª£c th√¥ng tin file nh·∫°c (ƒë·ªÉ l·∫•y t·ªïng th·ªùi l∆∞·ª£ng)
    audio.addEventListener('loadedmetadata', function() {
        if (audio.duration && !isNaN(audio.duration)) {
            totalTimeEl.textContent = formatTime(audio.duration);
        }
    });

    // 2. S·ª± ki·ªán c·∫≠p nh·∫≠t li√™n t·ª•c khi nh·∫°c ƒëang ch·∫°y
    audio.addEventListener('timeupdate', function() {
        // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
        if(audio.currentTime) {
            currentTimeEl.textContent = formatTime(audio.currentTime);
        }

        // C·∫≠p nh·∫≠t thanh ch·∫°y (Progress Bar)
        if (audio.duration) {
            const percent = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = percent + "%";
        }
    });

    // 3. S·ª± ki·ªán b·∫•m v√†o thanh ti·∫øn tr√¨nh ƒë·ªÉ tua (Seek)
    if (progressBar) {
        progressBar.addEventListener('click', function(e) {
            if (!audio.src) return; // N·∫øu ch∆∞a c√≥ b√†i h√°t th√¨ kh√¥ng l√†m g√¨

            const width = this.clientWidth; // Chi·ªÅu r·ªông t·ªïng c·ªßa thanh
            const clickX = e.offsetX; // V·ªã tr√≠ click
            const duration = audio.duration; // T·ªïng th·ªùi l∆∞·ª£ng

            if (duration) {
                // T√≠nh to√°n th·ªùi gian m·ªõi
                audio.currentTime = (clickX / width) * duration;
            }
        });
    }

    // 4. H√†m ƒë·ªãnh d·∫°ng gi√¢y sang ph√∫t:gi√¢y (V√≠ d·ª•: 125s -> 02:05)
    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "0:00";

        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // --- LOGIC THANH TI·∫æN TR√åNH (C√ì K√âO TH·∫¢) ---

    var isDragging = false; // Bi·∫øn ki·ªÉm tra xem c√≥ ƒëang gi·ªØ chu·ªôt kh√¥ng

    // 1. C·∫≠p nh·∫≠t thanh ch·∫°y khi nh·∫°c ƒëang ph√°t (Ch·ªâ c·∫≠p nh·∫≠t khi KH√îNG k√©o)
    audio.addEventListener('timeupdate', function() {
        if (!isDragging) { // N·∫øu ƒëang k√©o th√¨ kh√¥ng ƒë·ªÉ nh·∫°c t·ª± c·∫≠p nh·∫≠t giao di·ªán, tr√°nh gi·∫≠t
            if(audio.currentTime) {
                currentTimeEl.textContent = formatTime(audio.currentTime);
            }
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressFill.style.width = percent + "%";
            }
        }
    });

    // 2. X·ª≠ l√Ω s·ª± ki·ªán K√âO TH·∫¢ (Drag)
    if (progressBar) {

        // Khi b·∫•m chu·ªôt xu·ªëng thanh ti·∫øn tr√¨nh
        progressBar.addEventListener('mousedown', function(e) {
            isDragging = true;
            updateProgress(e); // C·∫≠p nh·∫≠t ngay v·ªã tr√≠ click
        });

        // Khi di chuy·ªÉn chu·ªôt (trong l√∫c ƒëang gi·ªØ chu·ªôt)
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                updateProgress(e);
            }
        });

        // Khi th·∫£ chu·ªôt ra
        document.addEventListener('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                // L√∫c th·∫£ tay ra m·ªõi ch√≠nh th·ª©c tua nh·∫°c ƒë·∫øn v·ªã tr√≠ ƒë√≥
                const width = progressBar.clientWidth;
                const clickX = e.clientX - progressBar.getBoundingClientRect().left;
                const duration = audio.duration;

                if (duration) {
                    // Gi·ªõi h·∫°n clickX kh√¥ng ra ngo√†i thanh
                    let newTime = (clickX / width) * duration;
                    if(newTime < 0) newTime = 0;
                    if(newTime > duration) newTime = duration;

                    audio.currentTime = newTime;
                }
            }
        });
    }

    // H√†m t√≠nh to√°n v·ªã tr√≠ v√† hi·ªÉn th·ªã giao di·ªán khi k√©o
    function updateProgress(e) {
        const width = progressBar.clientWidth;
        // T√≠nh v·ªã tr√≠ chu·ªôt so v·ªõi thanh progressBar
        let clickX = e.clientX - progressBar.getBoundingClientRect().left;

        // Gi·ªõi h·∫°n kh√¥ng cho k√©o ra ngo√†i thanh
        if (clickX < 0) clickX = 0;
        if (clickX > width) clickX = width;

        const percent = (clickX / width) * 100;
        progressFill.style.width = percent + "%";

        // C·∫≠p nh·∫≠t s·ªë gi√¢y hi·ªÉn th·ªã t·∫°m th·ªùi khi ƒëang k√©o
        if (audio.duration) {
            const tempTime = (clickX / width) * audio.duration;
            currentTimeEl.textContent = formatTime(tempTime);
        }
    }
    // --- LOGIC VOLUME CONTROL ---

    const volumeSlider = document.getElementById('volumeSlider');
    const volumeFill = document.getElementById('volumeFill');
    const volumeIcon = document.getElementById('volumeIcon');
    let lastVolume = 1; // L∆∞u l·∫°i volume tr∆∞·ªõc khi mute ƒë·ªÉ kh√¥i ph·ª•c

    // 1. X·ª≠ l√Ω khi click v√†o thanh Volume ƒë·ªÉ ch·ªânh to nh·ªè
    if (volumeSlider) {
        volumeSlider.addEventListener('click', function(e) {
            const rect = this.getBoundingClientRect();
            const width = rect.width;
            let clickX = e.clientX - rect.left;

            // Gi·ªõi h·∫°n
            if(clickX < 0) clickX = 0;
            if(clickX > width) clickX = width;

            // T√≠nh ph·∫ßn trƒÉm (0 ƒë·∫øn 1)
            const percent = clickX / width;

            // C·∫≠p nh·∫≠t Audio
            audio.volume = percent;

            // (Giao di·ªán s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù s·ª± ki·ªán volumechange b√™n d∆∞·ªõi)
        });
    }

    // 2. L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi volume c·ªßa Audio (ƒê·ªìng b·ªô giao di·ªán)
    audio.addEventListener('volumechange', function() {
        // C·∫≠p nh·∫≠t thanh tr∆∞·ª£t
        const percent = audio.volume * 100;
        if(volumeFill) volumeFill.style.width = percent + "%";

        // C·∫≠p nh·∫≠t Icon (Loa to, Loa nh·ªè, Mute)
        if(audio.muted || audio.volume === 0) {
            volumeIcon.className = 'fas fa-volume-mute';
        } else if (audio.volume < 0.5) {
            volumeIcon.className = 'fas fa-volume-down';
        } else {
            volumeIcon.className = 'fas fa-volume-up';
        }
    });

    // 3. X·ª≠ l√Ω khi b·∫•m v√†o Icon Loa (B·∫≠t/T·∫Øt Mute)
    if (volumeIcon) {
        volumeIcon.addEventListener('click', function() {
            if (audio.muted || audio.volume === 0) {
                // ƒêang t·∫Øt -> B·∫≠t l·∫°i
                audio.muted = false;
                audio.volume = lastVolume || 1; // Kh√¥i ph·ª•c m·ª©c c≈©
            } else {
                // ƒêang b·∫≠t -> T·∫Øt ƒëi
                lastVolume = audio.volume; // L∆∞u m·ª©c hi·ªán t·∫°i
                audio.muted = true;
                audio.volume = 0; // K√©o v·ªÅ 0 cho ch·∫Øc
            }
        });
    }
    // --- LOGIC N√öT REPEAT (L·∫∂P L·∫†I) ---

    const repeatBtn = document.getElementById('repeatBtn');
    let isRepeat = false; // Bi·∫øn theo d√µi tr·∫°ng th√°i

    if (repeatBtn) {
        repeatBtn.addEventListener('click', function() {
            // 1. ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i (T·∫Øt -> B·∫≠t, B·∫≠t -> T·∫Øt)
            isRepeat = !isRepeat;

            // 2. C·∫≠p nh·∫≠t thu·ªôc t√≠nh loop c·ªßa th·∫ª Audio
            // N·∫øu isRepeat = true th√¨ audio s·∫Ω t·ª± ƒë·ªông ph√°t l·∫°i khi h·∫øt b√†i
            audio.loop = isRepeat;

            // 3. C·∫≠p nh·∫≠t giao di·ªán (Th√™m/X√≥a class active)
            if (isRepeat) {
                repeatBtn.classList.add('active');
                // (T√πy ch·ªçn) Hi·ªán th√¥ng b√°o nh·ªè
                // showNotification("ƒê√£ b·∫≠t l·∫∑p l·∫°i b√†i h√°t", "success");
            } else {
                repeatBtn.classList.remove('active');
                // showNotification("ƒê√£ t·∫Øt l·∫∑p l·∫°i", "success");
            }
        });
    }
    /* --- TOAST NOTIFICATION LOGIC --- */

    // 1. H√†m hi·ªÉn th·ªã th√¥ng b√°o (Global function)
    // type: 'success' ho·∫∑c 'error'
    window.showToast = function(message, type = 'success') {
        const container = document.getElementById('toast-container');

        // T·∫°o element th√¥ng b√°o
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        // Icon t∆∞∆°ng ·ª©ng
        const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

        toast.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
            <i class="fas ${iconClass}"></i>
            <span>${message}</span>
        </div>
    `;

        // Th√™m v√†o giao di·ªán
        container.appendChild(toast);

        // T·ª± ƒë·ªông x√≥a kh·ªèi DOM sau 3.5s (3s hi·ªán + 0.5s fadeOut)
        setTimeout(() => {
            toast.remove();
        }, 3500);
    };


    // --- H√ÄM 2: Logic ph√°t nh·∫°c ch√≠nh ---
    function playSong(song) {
        // [QUAN TR·ªåNG] Ki·ªÉm tra xem c√≥ link nh·∫°c kh√¥ng
        if (!song.musicUrl) {
            alert("B√†i h√°t n√†y ch∆∞a c√≥ link nh·∫°c!");
            return;
        }
        currentSongId = song.songId; // 1. L∆∞u ID b√†i m·ªõi v√†o bi·∫øn to√†n c·ª•c
        isViewCounted = false;
        totalListeningTime = 0; // Reset t·ªïng th·ªùi gian nghe v·ªÅ 0
        lastTimePosition = 0;   // Reset v·ªã tr√≠ c≈© v·ªÅ 0

        // G√°n link Cloudinary v√†o tr√¨nh ph√°t
        audio.src = song.musicUrl;

        // --- C·∫≠p nh·∫≠t giao di·ªán Player (Footer) ---
        // B·∫°n c·∫ßn ƒë·∫£m b·∫£o file layout.html c√≥ c√°c class n√†y ·ªü ph·∫ßn Footer

        // 1. T√™n b√†i h√°t
        const titleEl = document.querySelector(".player-title");
        if (titleEl) titleEl.innerText = song.title;

        // 2. T√™n ngh·ªá sƒ©
        const artistEl = document.querySelector(".player-artist");
        if (artistEl) artistEl.innerText = song.artistName || "Unknown Artist"; // D√πng artistName t·ª´ DTO

        // 3. ·∫¢nh b√¨a (Cover)
        const coverEl = document.querySelector(".player-img");
        // ∆Øu ti√™n ·∫£nh b√¨a ri√™ng, n·∫øu kh√¥ng c√≥ th√¨ d√πng ·∫£nh m·∫∑c ƒë·ªãnh
        if (coverEl) coverEl.src = song.imageUrl || song.imageUrl || '/images/default-cover.png';

        // --- [TH√äM M·ªöI] G·ªåI API L∆ØU L·ªäCH S·ª¨ T·∫†I ƒê√ÇY ---
        fetch(`/api/history?songId=${song.songId}`, {
            method: 'POST'
        }).then(res => {
            console.log("ƒê√£ l∆∞u l·ªãch s·ª≠ nghe nh·∫°c");
        }).catch(err => {
            console.error("L·ªói l∆∞u l·ªãch s·ª≠:", err);
        });

        // --- B·∫Øt ƒë·∫ßu ph√°t ---
        audio.load(); // Load link m·ªõi
        audio.currentTime = 0;

        audio.play().then(() => {
            lastTimePosition = audio.currentTime;
            isPlaying = true;
            updatePlayPauseIcon(); // ƒê·ªïi icon n√∫t Play th√†nh Pause
        }).catch(err => {
            console.error("L·ªói khi ph√°t nh·∫°c:", err);
            alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t n√†y (L·ªói: " + err.message + ")");
        });

    }

    // 2. T·ª± ƒë·ªông check tin nh·∫Øn t·ª´ Server khi load trang
    document.addEventListener('DOMContentLoaded', function() {
        const successMsg = document.getElementById('serverSuccessMsg').value;
        const errorMsg = document.getElementById('serverErrorMsg').value;

        if (successMsg && successMsg.trim() !== "") {
            showToast(successMsg, 'success');
        }

        if (errorMsg && errorMsg.trim() !== "") {
            showToast(errorMsg, 'error');
        }
    });
</script>
<th:block layout:fragment="extra-js"></th:block>
</body>
</html>