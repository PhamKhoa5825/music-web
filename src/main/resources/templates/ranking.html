<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bảng Xếp Hạng - MusicPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --bg-body: #050505; --cyan-neon: #00f3ff; --text-main: #ffffff; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        .main-content { margin-left: 240px; min-height: 100vh; display: flex; flex-direction: column; }

        /* Sidebar styles sẽ được load từ fragment, nhưng giữ class main-content để đẩy nội dung */

        /* Header Style */
        .top-header { background-color: rgba(5, 5, 5, 0.95); position: sticky; top: 0; z-index: 900; padding: 15px 30px; border-bottom: 1px solid #1a1a1a; backdrop-filter: blur(10px); }

        /* Rank Styles */
        .rank-card { background: #111; border: 1px solid #333; border-radius: 8px; transition: 0.3s; }
        .rank-card:hover { border-color: var(--cyan-neon); background: #1a1a1a; }
        .rank-number { font-size: 2rem; font-weight: 900; -webkit-text-stroke: 1px var(--cyan-neon); color: transparent; }
        .top-1 .rank-number { color: var(--cyan-neon); -webkit-text-stroke: 0; text-shadow: 0 0 10px var(--cyan-neon); }
        .top-2 .rank-number { color: #00ff9d; -webkit-text-stroke: 0; }
        .top-3 .rank-number { color: #ff0055; -webkit-text-stroke: 0; }

        .filter-btn { background: transparent; border: 1px solid #444; color: #888; margin-right: 5px; }
        .filter-btn.active { background: var(--cyan-neon); color: black; border-color: var(--cyan-neon); font-weight: bold; }
    </style>
</head>
<body>

<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="main-content">
    <div class="top-header d-flex justify-content-end align-items-center">
        <div class="d-flex align-items-center gap-3">
            <span class="text-secondary small">RANKING SYSTEM</span>
            <img src="https://placehold.co/40" class="rounded-circle border border-secondary">
        </div>
    </div>

    <div class="container py-5 flex-grow-1">
        <h2 class="mb-4 text-uppercase fw-bold" style="color: var(--cyan-neon)">
            <i class="bi bi-trophy-fill me-2"></i>Bảng Xếp Hạng
        </h2>

        <div class="d-flex flex-wrap gap-3 mb-5 align-items-center bg-dark p-3 rounded border border-secondary">
            <div>
                <span class="text-muted me-2 small fw-bold">THỜI GIAN:</span>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm filter-btn active" onclick="changeMode(this, 'DAY')">Hôm nay</button>
                    <button type="button" class="btn btn-sm filter-btn" onclick="changeMode(this, 'WEEK')">Tuần này</button>
                    <button type="button" class="btn btn-sm filter-btn" onclick="changeMode(this, 'MONTH')">Tháng này</button>
                </div>
            </div>
            <div class="border-start border-secondary mx-2"></div>
            <div>
                <span class="text-muted me-2 small fw-bold">THỂ LOẠI:</span>
                <select id="genre-select" class="form-select form-select-sm bg-black text-white border-secondary d-inline-block w-auto" onchange="loadRanking()">
                    <option value="">Tất cả thể loại</option>
                </select>
            </div>
        </div>

        <div id="ranking-list" class="d-flex flex-column gap-3"></div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<div th:replace="~{fragments/sidebar :: create-playlist-modal}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // [FIX] Thống nhất tên biến API
    const API = '/api';
    let currentMode = 'DAY';
    const USER_ID = localStorage.getItem('music_user_id') || 1;

    // Sidebar Variables
    let sidebarPlaylistsData = [];
    let isSidebarExpanded = false;

    // --- 1. RANKING LOGIC ---
    async function loadGenres() {
        try {
            const res = await fetch('/admin/api/genres');
            const genres = await res.json();
            const sel = document.getElementById('genre-select');
            genres.forEach(g => sel.innerHTML += `<option value="${g.genreId}">${g.name}</option>`);
        } catch(e){}
    }

    async function loadRanking() {
        const genreId = document.getElementById('genre-select').value;
        const container = document.getElementById('ranking-list');
        container.innerHTML = '<div class="text-center text-info"><div class="spinner-border"></div></div>';

        // [FIX] Sử dụng biến API đã thống nhất
        let url = `${API}/ranking?mode=${currentMode}`;
        if(genreId) url += `&genreId=${genreId}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            container.innerHTML = '';
            if(data.length===0) { container.innerHTML = '<div class="text-muted text-center">Chưa có dữ liệu</div>'; return;}

            data.forEach((item, index) => {
                const s = item.song;
                const rank = index + 1;
                const topClass = rank <= 3 ? `top-${rank}` : '';
                container.innerHTML += `
                    <div class="rank-card p-3 d-flex align-items-center ${topClass}">
                        <div class="me-4 rank-number" style="width: 40px; text-align: center;">${rank}</div>
                        <img src="${s.coverImage || 'https://placehold.co/60'}" class="rounded me-3" width="60" height="60" style="object-fit: cover;">
                        <div class="flex-grow-1">
                            <h5 class="mb-1 text-white fw-bold"><a href="/song/${s.songId}" class="text-white text-decoration-none">${s.title}</a></h5>
                            <small class="text-muted">${s.artist ? s.artist.name : 'Unknown'}</small>
                        </div>
                        <div class="text-end px-3">
                            <div class="fs-5 fw-bold text-info">${item.plays}</div>
                            <small class="text-muted" style="font-size: 0.7rem;">LƯỢT NGHE</small>
                        </div>
                    </div>`;
            });
        } catch(e) { console.error(e); }
    }

    function changeMode(btn, mode) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = mode;
        loadRanking();
    }

    // --- 2. SIDEBAR LOGIC (ĐÃ SỬA LỖI LOAD) ---
    async function loadSidebarPlaylists() {
        try {
            const res = await fetch(`${API}/playlists/user/${USER_ID}`);
            if(res.ok) {
                const data = await res.json();
                sidebarPlaylistsData = data.sort((a, b) => b.playlistId - a.playlistId);
                renderSidebarUI();
            }
        } catch(e) { console.error("Sidebar load err", e); }
    }

    function renderSidebarUI() {
        const container = document.getElementById('sidebar-playlists');
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(!container) return;
        container.innerHTML = '';

        const limit = isSidebarExpanded ? sidebarPlaylistsData.length : 5;
        const displayList = sidebarPlaylistsData.slice(0, limit);

        displayList.forEach(p => {
            container.innerHTML += `
                <a href="/playlist/${p.playlistId}" class="nav-link text-truncate py-2 text-white-50" style="font-size: 0.9rem;">
                    <i class="bi bi-music-note-list"></i> ${p.name}
                </a>`;
        });

        if (sidebarPlaylistsData.length > 5) {
            btnExpand.classList.remove('d-none');
            btnExpand.innerHTML = isSidebarExpanded
                ? 'Thu gọn <i class="bi bi-chevron-up ms-1"></i>'
                : `Xem thêm (${sidebarPlaylistsData.length - 5}) <i class="bi bi-chevron-down ms-1"></i>`;
        } else {
            btnExpand.classList.add('d-none');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const btnExpand = document.getElementById('btn-sidebar-expand');
        if(btnExpand) {
            btnExpand.addEventListener('click', () => {
                isSidebarExpanded = !isSidebarExpanded;
                renderSidebarUI();
            });
        }
        const btnCreate = document.getElementById('btn-create-playlist');
        if(btnCreate) {
            btnCreate.addEventListener('click', () => {
                document.getElementById('newPlName').value = '';
                new bootstrap.Modal(document.getElementById('createPlModal')).show();
            });
        }
    });

    async function createPlaylist() {
        const name = document.getElementById('newPlName').value;
        const isPublic = document.getElementById('isPublicCheck').checked;
        if(!name) return alert("Vui lòng nhập tên Playlist");
        try {
            await fetch(`${API}/playlists`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ userId: USER_ID, name: name, isPublic: isPublic })
            });
            alert("Tạo thành công!");
            bootstrap.Modal.getInstance(document.getElementById('createPlModal')).hide();
            loadSidebarPlaylists();
        } catch (e) { console.error(e); }
    }

    // INIT Calls
    loadGenres();
    loadRanking();
    loadSidebarPlaylists();
</script>
</body>
</html>