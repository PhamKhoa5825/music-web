<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AI DJ - MusicPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            background-color: #050505;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding-top: 70px; /* For fixed navbar */
        }
        .ai-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #00f3ff; }
        .ai-card:hover { box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }
        .ai-header { background: linear-gradient(90deg, #0f3460 0%, #1a1a2e 100%); }
        .typing-animation { overflow: hidden; border-right: 2px solid #00f3ff; white-space: nowrap; animation: typing 3.5s steps(40, end); }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        .feature-icon { width: 60px; height: 60px; border-radius: 50%; background: rgba(0, 243, 255, 0.1); display: flex; align-items: center; justify-content: center; }
        .mood-btn { transition: all 0.3s; border: 2px solid transparent; }
        .mood-btn:hover { transform: translateY(-3px); border-color: #00f3ff; }
        .mood-btn.active { background: #00f3ff !important; color: black !important; border-color: #00f3ff; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="main-content">
    <div class="ai-header py-5 mb-5">
        <div class="container text-center">
            <h1 class="display-4 fw-bold text-white mb-3">
                <i class="bi bi-robot text-info me-3"></i>
                AI DJ Th√¥ng Minh
            </h1>
            <p class="fs-5 text-white-50 mb-4">T·∫°o playlist ho√†n h·∫£o theo c·∫£m x√∫c, ho·∫°t ƒë·ªông v√† s·ªü th√≠ch c·ªßa b·∫°n</p>
            <div class="typing-animation d-inline-block">
                <span class="text-info fw-bold">"Ch√†o b·∫°n! T√¥i l√† DJ AI c·ªßa MusicPro"</span>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Quick Mood Selection -->
        <div class="mb-5">
            <h3 class="fw-bold text-white mb-4">
                <i class="bi bi-lightning-charge-fill text-warning me-2"></i>
                Ch·ªçn nhanh theo t√¢m tr·∫°ng
            </h3>
            <div class="d-flex flex-wrap gap-3 justify-content-center">
                <button class="btn btn-lg mood-btn btn-outline-info" onclick="quickMood('happy')">
                    <i class="bi bi-emoji-smile fs-3 d-block mb-2"></i>üòä Vui v·∫ª
                </button>
                <button class="btn btn-lg mood-btn btn-outline-success" onclick="quickMood('chill')">
                    <i class="bi bi-tree fs-3 d-block mb-2"></i>üåø Th∆∞ gi√£n
                </button>
                <button class="btn btn-lg mood-btn btn-outline-warning" onclick="quickMood('energetic')">
                    <i class="bi bi-lightning fs-3 d-block mb-2"></i>‚ö° NƒÉng l∆∞·ª£ng
                </button>
                <button class="btn btn-lg mood-btn btn-outline-primary" onclick="quickMood('focus')">
                    <i class="bi bi-laptop fs-3 d-block mb-2"></i>üéØ T·∫≠p trung
                </button>
                <button class="btn btn-lg mood-btn btn-outline-secondary" onclick="quickMood('romantic')">
                    <i class="bi bi-heart fs-3 d-block mb-2"></i>‚ù§Ô∏è L√£ng m·∫°n
                </button>
                <button class="btn btn-lg mood-btn btn-outline-danger" onclick="quickMood('workout')">
                    <i class="bi bi-activity fs-3 d-block mb-2"></i>üí™ T·∫≠p gym
                </button>
            </div>
        </div>

        <!-- AI Features -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="ai-card p-4 rounded-3 h-100">
                    <div class="feature-icon mb-3 mx-auto">
                        <i class="bi bi-magic text-info fs-2"></i>
                    </div>
                    <h4 class="fw-bold text-white mb-3">T·∫°o Playlist Th√¥ng Minh</h4>
                    <p class="text-white-50">AI ph√¢n t√≠ch s·ªü th√≠ch v√† t·∫°o playlist ph√π h·ª£p nh·∫•t v·ªõi b·∫°n</p>
                    <button class="btn btn-info w-100 mt-3" onclick="openAdvancedModal()">
                        <i class="bi bi-stars me-2"></i>Kh·ªüi t·∫°o
                    </button>
                </div>
            </div>

            <div class="col-md-4">
                <div class="ai-card p-4 rounded-3 h-100">
                    <div class="feature-icon mb-3 mx-auto">
                        <i class="bi bi-graph-up text-success fs-2"></i>
                    </div>
                    <h4 class="fw-bold text-white mb-3">Ph√¢n T√≠ch Th√≥i Quen</h4>
                    <p class="text-white-50">Hi·ªÉu r√µ gu √¢m nh·∫°c v√† ƒë·ªÅ xu·∫•t b√†i h√°t m·ªõi ph√π h·ª£p</p>
                    <button class="btn btn-success w-100 mt-3" onclick="analyzeHabits()">
                        <i class="bi bi-person-lines-fill me-2"></i>Ph√¢n t√≠ch
                    </button>
                </div>
            </div>

            <div class="col-md-4">
                <div class="ai-card p-4 rounded-3 h-100">
                    <div class="feature-icon mb-3 mx-auto">
                        <i class="bi bi-chat-left-text text-warning fs-2"></i>
                    </div>
                    <h4 class="fw-bold text-white mb-3">Tr·ª£ L√Ω √Çm Nh·∫°c</h4>
                    <p class="text-white-50">Chat v·ªõi AI ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n v√† gi·∫£i ƒë√°p v·ªÅ √¢m nh·∫°c</p>
                    <button class="btn btn-warning w-100 mt-3" onclick="openChatAssistant()">
                        <i class="bi bi-robot me-2"></i>Tr√≤ chuy·ªán
                    </button>
                </div>
            </div>
        </div>

        <!-- Advanced Form (Hidden by default) -->
        <div class="ai-card p-5 rounded-3 mb-5 d-none" id="advanced-form">
            <h3 class="fw-bold text-white mb-4">
                <i class="bi bi-sliders text-info me-2"></i>
                T√πy ch·ªânh n√¢ng cao
            </h3>
            <form id="aiCustomForm">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label text-white fw-bold">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control bg-black text-white border-secondary"
                                  rows="3" placeholder="VD: T√¥i mu·ªën playlist ƒë·ªÉ h·ªçc b√†i bu·ªïi t·ªëi..."
                                  id="customDescription"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white fw-bold">Ho·∫°t ƒë·ªông ch√≠nh</label>
                        <select class="form-select bg-black text-white border-secondary" id="customActivity">
                            <option value="">Ch·ªçn ho·∫°t ƒë·ªông...</option>
                            <option value="studying">üìö H·ªçc t·∫≠p/L√†m vi·ªác</option>
                            <option value="working out">üí™ T·∫≠p th·ªÉ d·ª•c</option>
                            <option value="driving">üöó L√°i xe</option>
                            <option value="partying">üéâ Ti·ªác t√πng</option>
                            <option value="relaxing">üåø Th∆∞ gi√£n</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label text-white fw-bold">S·ªë b√†i h√°t</label>
                        <input type="range" class="form-range" min="5" max="30" value="15" id="songCount">
                        <div class="d-flex justify-content-between">
                            <small class="text-white-50">5 b√†i</small>
                            <span class="text-info fw-bold" id="songCountValue">15 b√†i</span>
                            <small class="text-white-50">30 b√†i</small>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label text-white fw-bold">Rating t·ªëi thi·ªÉu</label>
                        <div class="star-rating">
                            <i class="bi bi-star-fill fs-4 cursor-pointer" onclick="setMinRating(1)"></i>
                            <i class="bi bi-star-fill fs-4 cursor-pointer" onclick="setMinRating(2)"></i>
                            <i class="bi bi-star-fill fs-4 cursor-pointer" onclick="setMinRating(3)"></i>
                            <i class="bi bi-star-fill fs-4 cursor-pointer" onclick="setMinRating(4)"></i>
                            <i class="bi bi-star-fill fs-4 cursor-pointer" onclick="setMinRating(5)"></i>
                        </div>
                        <small class="text-white-50 d-block mt-1">‚â• <span id="minRatingValue">3</span> sao</small>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label text-white fw-bold">Th·ªùi gian trong ng√†y</label>
                        <select class="form-select bg-black text-white border-secondary" id="timeOfDay">
                            <option value="">B·∫•t k·ª≥</option>
                            <option value="morning">üåÖ Bu·ªïi s√°ng</option>
                            <option value="afternoon">‚òÄÔ∏è Bu·ªïi chi·ªÅu</option>
                            <option value="evening">üåô Bu·ªïi t·ªëi</option>
                            <option value="night">üåå ƒê√™m khuya</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeHeard">
                            <label class="form-check-label text-white-50" for="excludeHeard">
                                Lo·∫°i tr·ª´ b√†i h√°t ƒë√£ nghe nhi·ªÅu l·∫ßn
                            </label>
                        </div>
                    </div>

                    <div class="col-12 text-center mt-4">
                        <button type="button" class="btn btn-info btn-lg px-5" onclick="submitCustomRequest()">
                            <i class="bi bi-magic me-2"></i>T·∫°o Playlist T√πy Ch·ªânh
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-3" onclick="closeAdvancedForm()">
                            H·ªßy
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div class="ai-card p-5 rounded-3 d-none" id="results-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold text-white mb-2">
                        <i class="bi bi-stars text-info me-2"></i>
                        K·∫øt Qu·∫£ AI DJ
                    </h3>
                    <p class="text-white-50" id="result-description">Playlist ƒë∆∞·ª£c t·∫°o theo y√™u c·∫ßu c·ªßa b·∫°n</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="savePlaylist()">
                        <i class="bi bi-plus-circle me-2"></i>L∆∞u Playlist
                    </button>
                    <button class="btn btn-outline-success" onclick="playAll()">
                        <i class="bi bi-play-fill me-2"></i>Ph√°t t·∫•t c·∫£
                    </button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-dark border-info text-center p-3">
                        <h4 class="text-info fw-bold mb-0" id="result-count">0</h4>
                        <small class="text-white-50">B√†i h√°t</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-success text-center p-3">
                        <h4 class="text-success fw-bold mb-0" id="result-duration">0</h4>
                        <small class="text-white-50">Ph√∫t</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-warning text-center p-3">
                        <h4 class="text-warning fw-bold mb-0" id="result-rating">0.0</h4>
                        <small class="text-white-50">Rating TB</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-primary text-center p-3">
                        <h4 class="text-primary fw-bold mb-0">AI</h4>
                        <small class="text-white-50">Powered</small>
                    </div>
                </div>
            </div>

            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="ai-results-list">
                <!-- Songs will be rendered here -->
            </div>

            <div class="text-center mt-5">
                <button class="btn btn-outline-light me-3" onclick="window.location.href='/foryou.html'">
                    <i class="bi bi-arrow-left me-2"></i>V·ªÅ D√†nh Cho B·∫°n
                </button>
                <button class="btn btn-info" onclick="openAdvancedModal()">
                    <i class="bi bi-arrow-repeat me-2"></i>T·∫°o playlist m·ªõi
                </button>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-info">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;"></div>
                <h5 class="text-white mb-2">AI ƒëang ch·ªçn nh·∫°c cho b·∫°n...</h5>
                <p class="text-white-50">ƒêang ph√¢n t√≠ch v√† t·∫°o playlist ho√†n h·∫£o</p>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Assistant Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white border-info">
            <div class="modal-header border-info">
                <h5 class="modal-title text-info">
                    <i class="bi bi-robot me-2"></i>Tr·ª£ L√Ω √Çm Nh·∫°c AI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="height: 400px; overflow-y: auto;" id="chatMessages">
                <div class="alert alert-info bg-dark border-info">
                    <strong>AI:</strong> Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ √¢m nh·∫°c?
                </div>
            </div>
            <div class="modal-footer border-info">
                <input type="text" class="form-control bg-black text-white border-secondary"
                       placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ √¢m nh·∫°c..." id="chatInput">
                <button class="btn btn-info" onclick="sendChatMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = '/api';
    const USER_ID = localStorage.getItem('music_user_id') || 1;
    let minRating = 3;

    // Update song count value
    document.getElementById('songCount').addEventListener('input', function() {
        document.getElementById('songCountValue').textContent = this.value + ' b√†i';
    });

    function setMinRating(rating) {
        minRating = rating;
        document.getElementById('minRatingValue').textContent = rating;
        const stars = document.querySelectorAll('.star-rating i');
        stars.forEach((star, idx) => {
            star.classList.toggle('text-warning', idx < rating);
            star.classList.toggle('text-secondary', idx >= rating);
        });
    }

    function openAdvancedModal() {
        document.getElementById('advanced-form').classList.remove('d-none');
        document.getElementById('results-section').classList.add('d-none');
    }

    function closeAdvancedForm() {
        document.getElementById('advanced-form').classList.add('d-none');
    }

    function quickMood(mood) {
        const moods = {
            'happy': 'vui v·∫ª, t√≠ch c·ª±c, s√¥i ƒë·ªông',
            'chill': 'th∆∞ gi√£n, nh·∫π nh√†ng, acoustic',
            'energetic': 'nƒÉng l∆∞·ª£ng cao, EDM, workout',
            'focus': 't·∫≠p trung, kh√¥ng l·ªùi, nh·∫°c n·ªÅn',
            'romantic': 'l√£ng m·∫°n, ballad, t√¨nh c·∫£m',
            'workout': 't·∫≠p gym, cardio, motivative'
        };

        document.getElementById('customDescription').value = `T√¥i mu·ªën nghe nh·∫°c ${moods[mood]}`;
        openAdvancedModal();
    }

    async function submitCustomRequest() {
        const description = document.getElementById('customDescription').value;
        const activity = document.getElementById('customActivity').value;
        const songCount = document.getElementById('songCount').value;
        const timeOfDay = document.getElementById('timeOfDay').value;
        const excludeHeard = document.getElementById('excludeHeard').checked;

        if (!description.trim()) {
            alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£ y√™u c·∫ßu');
            return;
        }

        // Show loading
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();

        try {
            const request = {
                description: description,
                moods: [getMoodFromDescription(description)],
                songCount: parseInt(songCount),
                minRating: minRating,
                activity: activity,
                timeOfDay: timeOfDay,
                excludeListened: excludeHeard
            };

            const res = await fetch(`${API}/gemini/advanced-recommend`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            const songs = await res.json();

            // Hide loading
            loadingModal.hide();

            // Show results
            displayResults(songs, description);

        } catch (error) {
            console.error('Error:', error);
            loadingModal.hide();
            alert('C√≥ l·ªói x·∫£y ra khi t·∫°o playlist. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    function getMoodFromDescription(desc) {
        const moods = ['vui v·∫ª', 'bu·ªìn', 'l√£ng m·∫°n', 'nƒÉng l∆∞·ª£ng', 'th∆∞ gi√£n', 't·∫≠p trung'];
        for (let mood of moods) {
            if (desc.toLowerCase().includes(mood)) return mood;
        }
        return 'ƒëa d·∫°ng';
    }

    function displayResults(songs, description) {
        document.getElementById('advanced-form').classList.add('d-none');
        const resultsSection = document.getElementById('results-section');
        resultsSection.classList.remove('d-none');

        document.getElementById('result-description').textContent = description;
        document.getElementById('result-count').textContent = songs.length;
        document.getElementById('result-duration').textContent = Math.round(songs.length * 3.5);
        document.getElementById('result-rating').textContent = '4.2';

        const container = document.getElementById('ai-results-list');
        container.innerHTML = songs.map(song => `
                <div class="col">
                    <div class="card bg-dark border-secondary h-100">
                        <img src="${song.coverImage || 'https://placehold.co/300'}" class="card-img-top" style="aspect-ratio: 1/1; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title text-white text-truncate">${song.title}</h6>
                            <p class="card-text text-white-50 small text-truncate">${song.artist?.name || 'Unknown'}</p>
                            <button class="btn btn-sm btn-outline-info w-100" onclick="playSong(${song.songId})">
                                <i class="bi bi-play-fill"></i> Ph√°t
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    function savePlaylist() {
        const playlistName = prompt('Nh·∫≠p t√™n cho playlist m·ªõi:', 'AI Playlist - ' + new Date().toLocaleDateString());
        if (playlistName) {
            alert(`ƒê√£ l∆∞u playlist "${playlistName}" th√†nh c√¥ng!`);
            // In a real app, you would call API to save the playlist
        }
    }

    function playAll() {
        alert('T√≠nh nƒÉng ph√°t t·∫•t c·∫£ ƒëang ph√°t tri·ªÉn');
    }

    function analyzeHabits() {
        window.location.href = '/history.html';
    }

    function openChatAssistant() {
        const modal = new bootstrap.Modal(document.getElementById('chatModal'));
        modal.show();
    }

    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        const chatBox = document.getElementById('chatMessages');

        // Add user message
        chatBox.innerHTML += `
                <div class="text-end mb-2">
                    <span class="bg-info text-dark p-2 rounded">${message}</span>
                </div>
            `;

        input.value = '';

        // Simulate AI response
        setTimeout(() => {
            const responses = [
                "D·ª±a tr√™n s·ªü th√≠ch c·ªßa b·∫°n, t√¥i ƒë·ªÅ xu·∫•t b·∫°n nghe th·ªÉ lo·∫°i Pop v√† Indie!",
                "B·∫°n c√≥ mu·ªën t√¥i t·∫°o m·ªôt playlist theo t√¢m tr·∫°ng hi·ªán t·∫°i kh√¥ng?",
                "B√†i h√°t ph·ªï bi·∫øn nh·∫•t tu·∫ßn n√†y l√† 'Shape of You' c·ªßa Ed Sheeran",
                "T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m b√†i h√°t ph√π h·ª£p v·ªõi ho·∫°t ƒë·ªông s·∫Øp t·ªõi",
                "D·ª±a tr√™n l·ªãch s·ª≠ nghe, b·∫°n th√≠ch nh·∫°c c√≥ giai ƒëi·ªáu vui t∆∞∆°i v√† tempo trung b√¨nh"
            ];

            const response = responses[Math.floor(Math.random() * responses.length)];

            chatBox.innerHTML += `
                    <div class="text-start mb-2">
                        <span class="bg-secondary text-white p-2 rounded"><strong>AI:</strong> ${response}</span>
                    </div>
                `;

            chatBox.scrollTop = chatBox.scrollHeight;
        }, 1000);
    }

    function playSong(songId) {
        fetch(`${API}/history?userId=${USER_ID}&songId=${songId}`, {method: 'POST'});
        alert('ƒêang ph√°t b√†i h√°t...');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        setMinRating(3);
    });
</script>
<script src="/js/global-player.js"></script>
</body>
</html>